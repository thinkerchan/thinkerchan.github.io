<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <link rel="dns-prefetch" href="https://thinkerchan.com">
  
  <title>【快速教程】编写一个JS评论组件 | 测试狗</title>
  <meta name="author" content="测试狗">
  
  <meta name="description" content="老陈">
  
  
  <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

  <meta property="og:title" content="【快速教程】编写一个JS评论组件"/>
  <meta property="og:site_name" content="测试狗"/>

  
    <meta property="og:image" content=""/>
  

  <link rel="alternate" href="/atom.xml" title="测试狗" type="application/atom+xml">

  <link rel="preload" as="style" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

  <link rel="icon" class="js-site-favicon" type="image/svg+xml" href="https://github.githubassets.com/favicons/favicon.svg">
  <link href="https://unpkg.com" rel="dns-prefetch" />
  <link href="https://busuanzi.ibruce.info" rel="dns-prefetch" />
  <link href="https://cdn1.lncld.net" rel="dns-prefetch" />
  
  <link href="https://xpjzs0ff.api.lncld.net" rel="dns-prefetch" />
  
</head>

<body>
  <div class="container">
    <div class="left-col" style="background-image:url('https://tva1.sinaimg.cn/large/007S8ZIlgy1ggdmi6yapmj30dw0zk0wm.jpg')">
      <div class="intrude-less">
        <header id="header" class="inner">
          <a href="/">
            <div class="profilepic"><img src='https://tva1.sinaimg.cn/large/007S8ZIlgy1ggdmr1k3k0j305k05k74j.jpg'></div>
          </a>
          <div class="author-name"><a href="/">测试狗</a></div>
          <p class="aboutme">老陈</p>
          <nav id="main-nav">
            <ul class="main">
              
              <li>
                
                  <a href="/archives">归档</a>
                
              </li>
              
              <li>
                
                  <a href="/categories">专题</a>
                
              </li>
              
              <li>
                
                  <a href="/friendlinks">友链</a>
                
              </li>
              
              <li>
                
                  <a href="/life">关于</a>
                
              </li>
              
              <li>
                
                  <a href="/search">搜索</a>
                
              </li>
              
            </ul>
          </nav>
          <nav id="sub-nav">
            <div class="social">
              
              <a class="twitter" href="https://twitter.com/thinkerchan" title="Twitter">Twitter</a>
              
              
              
              <a class="github" href="https://github.com/thinkerchan" title="Github">Github</a>
              
              
              <a class="yuque" href="https://yuque.com/testdog" title="语雀">语雀</a>
              

              
              <a class="rss" href="/atom.xml" title="RSS">RSS</a>
              
            </div>
          </nav>
        </header>
      </div>
    </div>
    <div class="mid-col">
      <div class="mid-col-container">
        <div id="content" class="inner">
          <article class="post">

  
    <div class="meta">
      
<div class="date">

<time datetime="2018-09-30T00:33:00.000Z"
      
      data-updated="true"
       itemprop="datePublished">
  2018-09-30
</time>





</div>

    </div>
  
  <h1 class="title" itemprop="name">【快速教程】编写一个JS评论组件</h1>
  <div class="entry-content" itemprop="articleBody">
    
    <div class="post-toc">
      <div class="toc-title">TOC</div>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#效果"><span class="toc-number">2.</span> <span class="toc-text">效果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#大概需求"><span class="toc-number">3.</span> <span class="toc-text">大概需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#源码"><span class="toc-number">4.</span> <span class="toc-text">源码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其他"><span class="toc-number">5.</span> <span class="toc-text">其他</span></a></li></ol>
    </div>
    
    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>当初在老东家搬砖的时候, 负责评论组件这一块的前端重构。刚好17年年中那会, 国家法律要求所有能够发表言论的地方, 都得接入实名制, 于是用了很久的”多说”,也不免中枪,挂了。本来想着自己要不用前后端都写了, 弄一套开源的评论系统好了,结果从离职后到现在种种忙活都没写完(自我检讨中)。</p>
<p>刚好前段时间用到<a href="https://leancloud.cn/" target="_blank" rel="noopener">LeanCloud</a>这个还不错的产品(真没打广告), 继而发现了<a href="https://valine.js.org/" target="_blank" rel="noopener">Valine</a>这个评论组件, 接入了LeanCloud。</p>
<p>那我干嘛还自己写评论系统（反正后端没写完）？直接用Valine不香吗。不过既然也写了一部分，那也改造下，算是一个入门级别的评论组件编写教程吧.</p>
<p>另外说一句, Valine已经很完善了, 包括后面有人完善<a href="https://github.com/panjunwen/Valine-Admin" target="_blank" rel="noopener">Valine-admin</a>这样的辅助工具. 说这些也并非不建议大家重复造轮子. 只不过如果掌握了这个技能，就不要再做重复的事情。</p>
<h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p>既然是demo,那只用ES6和css3开发, 只能用高级浏览器<a href="https://thinkerchan.github.io/cmt/" target="_blank" rel="noopener">查看</a></p>
<h2 id="大概需求"><a href="#大概需求" class="headerlink" title="大概需求"></a>大概需求</h2><p>因为只有LeanCloud,没有自己的后台, 所以有些功能没法做(其实也不是没法做, 只是效果不好)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@k 评论原型</span><br><span class="line"></span><br><span class="line">主要部分</span><br><span class="line">1.评论框复用 //√</span><br><span class="line">2.对用户输入进行转义 //√</span><br><span class="line">3.评论数据结构复用 //√</span><br><span class="line">4.异步加载样式表  // √</span><br><span class="line">5.Ajax  // 因为用了leancloud,所以直接用它的SDK</span><br><span class="line">6.留言排序可选 // × 直接从旧到新</span><br><span class="line">7. 基于localstorage存储网友的昵称/邮箱/网址</span><br><span class="line">8. md5拼接邮箱生成头像 //基于gavatar</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">TODO</span><br><span class="line">1. 留言点赞功能 //非限定次数(删除cookie依然可以点赞)</span><br><span class="line">2. 用户登录/注册  // 要做吗?</span><br><span class="line">3. 验证码  //需要后端配合</span><br><span class="line">5.表情处理(类似新浪微博处理方式比较合理) //✘</span><br><span class="line">6.楼层嵌套  //类似biliili</span><br><span class="line">7.分页</span><br><span class="line">8.楼层ID处理 // normal则不需要处理, 楼层嵌套则要过滤不含有targetFloor的cid</span><br></pre></td></tr></table></figure>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><p>麻雀虽小，五脏俱全。看了之后保证你也能写一个Valine了（正经脸）。<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">;(<span class="function"><span class="keyword">function</span>(<span class="params">win,doc</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// https://leancloud.cn/docs/leanstorage_guide-js.html</span></span><br><span class="line">   <span class="keyword">let</span> CONFIG = &#123;</span><br><span class="line">     dataBase:<span class="string">'CMT'</span>, <span class="comment">//创建一个表名</span></span><br><span class="line">     avatarUrl:<span class="string">'https://cdn.v2ex.com/gravatar/'</span>,  <span class="comment">//默认头像 +md5(email)可做标识</span></span><br><span class="line">     sort:<span class="literal">false</span>,  <span class="comment">//默认新旧排序</span></span><br><span class="line">     replyType: <span class="string">'normal'</span>,</span><br><span class="line">     cmtType:<span class="string">'textarea'</span>,  <span class="comment">//div, textarea</span></span><br><span class="line">     placeholder:<span class="string">"欢迎灌水"</span>,</span><br><span class="line">     lsPrefix:<span class="string">'CMT'</span>,</span><br><span class="line">     lsArr:[<span class="string">'nick'</span>,<span class="string">'email'</span>,<span class="string">'link'</span>]</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 要存的数据结构</span></span><br><span class="line">   <span class="keyword">let</span> cmtDataObj = &#123;</span><br><span class="line">      comment: <span class="string">''</span>,   <span class="comment">// 评论内容</span></span><br><span class="line">      nick: <span class="string">'游客'</span>,  <span class="comment">//昵称</span></span><br><span class="line">      email: <span class="string">''</span>,  <span class="comment">//用户邮箱</span></span><br><span class="line">      link: <span class="string">''</span>,  <span class="comment">//用户主页</span></span><br><span class="line">      ua: navigator.userAgent,</span><br><span class="line">      url: win.location.pathname.replace(<span class="regexp">/index\.(html|htm)/</span>, <span class="string">''</span>),</span><br><span class="line">      captcha: <span class="number">0</span>,</span><br><span class="line">      like: <span class="number">0</span>,</span><br><span class="line">      dislike:<span class="number">0</span>,</span><br><span class="line">      targetFloor:<span class="string">''</span>  <span class="comment">//存储回复楼层的ID</span></span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 辅助模块</span></span><br><span class="line">   <span class="keyword">let</span> Tool = &#123;</span><br><span class="line">     formatDate(date,bool)&#123;</span><br><span class="line">       <span class="keyword">const</span> padWithZeros = <span class="function">(<span class="params">vNumber, width</span>) =&gt;</span> &#123;</span><br><span class="line">         <span class="keyword">let</span> numAsString = vNumber.toString();</span><br><span class="line">         <span class="keyword">while</span> (numAsString.length &lt; width) &#123;</span><br><span class="line">           numAsString = <span class="string">'0'</span> + numAsString;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> numAsString;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">let</span> vDay = padWithZeros(date.getDate(), <span class="number">2</span>);</span><br><span class="line">       <span class="keyword">let</span> vMonth = padWithZeros(date.getMonth() + <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">       <span class="keyword">let</span> vYear = padWithZeros(date.getFullYear(), <span class="number">2</span>);</span><br><span class="line">       <span class="keyword">if</span> (bool) &#123;</span><br><span class="line">         <span class="keyword">let</span> vH = date.getHours();</span><br><span class="line">         <span class="keyword">let</span> vM = date.getMinutes();</span><br><span class="line">         <span class="keyword">let</span> vS = date.getSeconds();</span><br><span class="line">         <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">s</span>)</span>&#123;</span><br><span class="line">           <span class="keyword">return</span> (<span class="string">''</span>+s).length ==<span class="number">1</span>? <span class="string">'0'</span>+s : s;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;vYear&#125;</span>-<span class="subst">$&#123;vMonth&#125;</span>-<span class="subst">$&#123;vDay&#125;</span> <span class="subst">$&#123;f(vH)&#125;</span>:<span class="subst">$&#123;f(vM)&#125;</span>:<span class="subst">$&#123;f(vS)&#125;</span>`</span>;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;vYear&#125;</span>-<span class="subst">$&#123;vMonth&#125;</span>-<span class="subst">$&#123;vDay&#125;</span>`</span>;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="comment">// 格式化时间</span></span><br><span class="line">     formatTime(date)&#123;</span><br><span class="line">       <span class="keyword">let</span> serTime = date.getTime();</span><br><span class="line">       <span class="keyword">let</span> curTime = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</span><br><span class="line">       <span class="keyword">let</span> diff = curTime - serTime;</span><br><span class="line">       <span class="keyword">let</span> day = <span class="built_in">Math</span>.floor(diff / (<span class="number">24</span> * <span class="number">3600</span> * <span class="number">1000</span>));</span><br><span class="line">       <span class="keyword">if</span> (day === <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="keyword">let</span> remainMsFromeH = diff % (<span class="number">24</span> * <span class="number">3600</span> * <span class="number">1000</span>);</span><br><span class="line">         <span class="keyword">let</span> hour = <span class="built_in">Math</span>.floor(remainMsFromeH / (<span class="number">3600</span> * <span class="number">1000</span>));</span><br><span class="line">         <span class="keyword">if</span> (hour === <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">let</span> remainMsFromeM = remainMsFromeH % (<span class="number">3600</span> * <span class="number">1000</span>);</span><br><span class="line">           <span class="keyword">let</span> minute = <span class="built_in">Math</span>.floor(remainMsFromeM / (<span class="number">60</span> * <span class="number">1000</span>));</span><br><span class="line">           <span class="keyword">if</span> (minute === <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="keyword">let</span> remainMsFromeS = remainMsFromeM % (<span class="number">60</span> * <span class="number">1000</span>)</span><br><span class="line">             <span class="keyword">let</span> second = <span class="built_in">Math</span>.round(remainMsFromeS / <span class="number">1000</span>);</span><br><span class="line">             <span class="keyword">return</span> second + <span class="string">' 秒前'</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> minute + <span class="string">' 分钟前'</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> hour + <span class="string">' 小时前'</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (day &lt; <span class="number">1</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> day + <span class="string">' 天前'</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">this</span>.formatDate(date)</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 模板模块</span></span><br><span class="line">   <span class="keyword">let</span> TPL=&#123;</span><br><span class="line">     mainView()&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">         &lt;div class="cmt-area cmt-postcomment"&gt;</span></span><br><span class="line"><span class="string">           &lt;div class="cmt-area-hd"&gt;</span></span><br><span class="line"><span class="string">             &lt;div class="cmt-area-tit"&gt;网友评论&lt;/div&gt;</span></span><br><span class="line"><span class="string">             &lt;div class="cmt-count-wrap"&gt;共有&lt;span class="cmt-count"&gt;0&lt;/span&gt;条评论&lt;/div&gt;</span></span><br><span class="line"><span class="string">           &lt;/div&gt;</span></span><br><span class="line"><span class="string">         &lt;/div&gt;</span></span><br><span class="line"><span class="string">         &lt;div class="cmt-content"&gt;</span></span><br><span class="line"><span class="string">           &lt;ul class="cmt-list" id="JcmtList"&gt;&lt;/ul&gt;</span></span><br><span class="line"><span class="string">         &lt;/div&gt;</span></span><br><span class="line"><span class="string">       `</span></span><br><span class="line">     &#125;,</span><br><span class="line">     cmtFormTpl(bool)&#123; <span class="comment">//评论框模板</span></span><br><span class="line">        <span class="comment">// div+contenteditable , 默认转义用户输入 ,textarea等,不会被转义,要过滤</span></span><br><span class="line">       <span class="keyword">let</span> con = <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">if</span> (CONFIG.cmtType==<span class="string">'div'</span>) &#123;</span><br><span class="line">         con = <span class="string">'&lt;div class="cmt-main-txtarea" contenteditable id="&#123;&#123;cmtId&#125;&#125;" placeholder="'</span>+CONFIG.placeholder+<span class="string">'"&gt;&lt;/div&gt;'</span></span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         con = <span class="string">'&lt;textarea class="cmt-main-txtarea" placeholder="'</span>+CONFIG.placeholder+<span class="string">'" id="&#123;&#123;cmtId&#125;&#125;"&gt;&lt;/textarea&gt;'</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">let</span> hd = <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">if</span> (!bool) &#123;</span><br><span class="line">          hd =<span class="string">`&lt;div class="cmt-login-area"&gt;</span></span><br><span class="line"><span class="string">             &lt;input  class="cmt-login-ipt" placeholder="昵 称" id="Jnick" data-name="nick"/&gt;</span></span><br><span class="line"><span class="string">             &lt;input  class="cmt-login-ipt" placeholder="邮 箱" id="Jemail" data-name="email"/&gt;</span></span><br><span class="line"><span class="string">             &lt;input  class="cmt-login-ipt" placeholder="个人网站" id="Jlink" data-name="link"/&gt;</span></span><br><span class="line"><span class="string">           &lt;/div&gt;`</span>;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          hd=<span class="string">''</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">         &lt;div class="cmt-area-bd"&gt;</span></span><br><span class="line"><span class="string">            <span class="subst">$&#123;hd&#125;</span></span></span><br><span class="line"><span class="string">           &lt;div class="cmt-main-txtarea-wrap"&gt;</span></span><br><span class="line"><span class="string">             <span class="subst">$&#123;con&#125;</span></span></span><br><span class="line"><span class="string">           &lt;/div&gt;</span></span><br><span class="line"><span class="string">         &lt;/div&gt;</span></span><br><span class="line"><span class="string">         &lt;div class="cmt-area-ft"&gt;</span></span><br><span class="line"><span class="string">           &lt;a  class="btn cmt-main-txtarea-sbmt-btn" data-event="&#123;&#123;eventType&#125;&#125;"&gt;&#123;&#123;btnTxt&#125;&#125;&lt;/a&gt;</span></span><br><span class="line"><span class="string">         &lt;/div&gt;</span></span><br><span class="line"><span class="string">       `</span></span><br><span class="line">     &#125;,</span><br><span class="line">     cmtItemTpl()&#123; <span class="comment">//评论数据模板</span></span><br><span class="line">       <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">         &lt;div class="cmt-user-avatar"&gt;</span></span><br><span class="line"><span class="string">           &lt;a href="&#123;&#123;userCenter&#125;&#125;" class="user-center-link" target="_blank"&gt;</span></span><br><span class="line"><span class="string">             &lt;img class="user-avatar-img" src="&#123;&#123;avatarUrl&#125;&#125;"&gt;</span></span><br><span class="line"><span class="string">           &lt;/a&gt;</span></span><br><span class="line"><span class="string">         &lt;/div&gt;</span></span><br><span class="line"><span class="string">         &lt;div class="cmt-item-data-wrap" id="&#123;&#123;objectId&#125;&#125;" data-placeholder="&#123;&#123;userName&#125;&#125;"&gt;</span></span><br><span class="line"><span class="string">           &lt;div class="cmt-item-data-hd"&gt;</span></span><br><span class="line"><span class="string">             &lt;span class="cmt-item-data-floor"&gt;#&#123;&#123;floor&#125;&#125;&lt;/span&gt;</span></span><br><span class="line"><span class="string">             &lt;span class="cmt-item-data-user"&gt;&#123;&#123;userName&#125;&#125;&lt;/span&gt;</span></span><br><span class="line"><span class="string">             &lt;span class="cmt-item-data-time"&gt;&#123;&#123;createTime&#125;&#125;&lt;/span&gt;</span></span><br><span class="line"><span class="string">           &lt;/div&gt;</span></span><br><span class="line"><span class="string">           &lt;p class="cmt-item-data"&gt;&#123;&#123;cmtData&#125;&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">           &lt;div class="cmt-item-data-hd-ft"&gt;</span></span><br><span class="line"><span class="string">             &lt;a class="cmt-item-reply-btn" data-event="reply" data-id="&#123;&#123;objectId&#125;&#125;"&gt;回复&lt;/a&gt;</span></span><br><span class="line"><span class="string">           &lt;/div&gt;</span></span><br><span class="line"><span class="string">           &lt;ul class="reply-list" id="&#123;&#123;UlId&#125;&#125;"&gt;</span></span><br><span class="line"><span class="string">             &lt;!--placeholder--&gt;</span></span><br><span class="line"><span class="string">           &lt;/ul&gt;</span></span><br><span class="line"><span class="string">         &lt;/div&gt;</span></span><br><span class="line"><span class="string">     `</span>&#125;,</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 主要逻辑</span></span><br><span class="line">   <span class="keyword">let</span> CMT = &#123;</span><br><span class="line">     init(configObj)&#123;</span><br><span class="line">       <span class="keyword">if</span> (!configObj.el) &#123;</span><br><span class="line">         <span class="built_in">console</span>.log(<span class="string">'缺少目标容器'</span>);</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (!configObj.appId) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'请填写appId'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (!configObj.appKey) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'请填写appKey'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span>(<span class="keyword">typeof</span> MD5==<span class="string">'undefined'</span>)&#123;</span><br><span class="line">        <span class="keyword">this</span>.MD5=<span class="function"><span class="keyword">function</span>(<span class="params">str</span>)</span>&#123;<span class="keyword">return</span> str&#125;;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.MD5=MD5;</span><br><span class="line">       &#125;</span><br><span class="line">       AV.init(configObj.appId, configObj.appKey);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.el = <span class="built_in">document</span>.querySelector(configObj.el);</span><br><span class="line">       <span class="comment">// 渲染模板</span></span><br><span class="line">       <span class="keyword">this</span>.buildTpl();</span><br><span class="line">       <span class="comment">// 出所有评论</span></span><br><span class="line">       <span class="keyword">this</span>.renderAllCmt();</span><br><span class="line">       <span class="comment">// 绑定各种事件</span></span><br><span class="line">       <span class="keyword">this</span>.bindEvent();</span><br><span class="line">       <span class="comment">// 读取localstorage</span></span><br><span class="line">       <span class="keyword">this</span>.fetchUserInfo();</span><br><span class="line">     &#125;,</span><br><span class="line">     buildTpl()&#123;</span><br><span class="line">       <span class="keyword">this</span>.generateMainView();  <span class="comment">//主界面结构</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.generateForm(&#123; <span class="comment">// 生成主评论框</span></span><br><span class="line">         cmtId : <span class="string">'JmainCmt'</span>,</span><br><span class="line">         eventType: <span class="string">'postCmt'</span>,</span><br><span class="line">         btnTxt: <span class="string">'提交评论'</span>,</span><br><span class="line">         callBack:<span class="function">(<span class="params">newCmtEle</span>)=&gt;</span>&#123;</span><br><span class="line">           doc.querySelector(<span class="string">'.cmt-postcomment'</span>).appendChild(newCmtEle);</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">     &#125;,</span><br><span class="line">     generateReplyForm(cb)&#123;</span><br><span class="line">       <span class="keyword">this</span>.generateForm(&#123;  <span class="comment">// 生成回复框, 初始状态隐藏</span></span><br><span class="line">         cmtId : <span class="string">'JreplyCmt'</span>,</span><br><span class="line">         eventType: <span class="string">'postReply'</span>,</span><br><span class="line">         btnTxt: <span class="string">'提交回复'</span>,</span><br><span class="line">         hideLoginArea:<span class="literal">true</span>,</span><br><span class="line">         callBack:<span class="function">(<span class="params">newCmtEle</span>)=&gt;</span>&#123;</span><br><span class="line">           <span class="keyword">this</span>.replyForm =  newCmtEle.cloneNode(<span class="literal">true</span>);</span><br><span class="line">           cb &amp;&amp; cb();</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">     &#125;,</span><br><span class="line">     generateMainView()&#123;</span><br><span class="line">       <span class="keyword">this</span>.el.innerHTML = TPL.mainView()</span><br><span class="line">     &#125;,</span><br><span class="line">     generateForm(configObj)&#123;</span><br><span class="line">       <span class="keyword">let</span> div = doc.createElement(<span class="string">'div'</span>)</span><br><span class="line">       div.classList +=<span class="string">'cmt-area-con'</span>;</span><br><span class="line">       div.innerHTML = TPL.cmtFormTpl(configObj.hideLoginArea)</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;eventType&#125;&#125;/g</span>,configObj.eventType)</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;btnTxt&#125;&#125;/g</span>,configObj.btnTxt)</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;cmtId&#125;&#125;/g</span>,configObj.cmtId);</span><br><span class="line">       configObj.callBack &amp;&amp; configObj.callBack(div);</span><br><span class="line">     &#125;,</span><br><span class="line">     getData(el,name)&#123;</span><br><span class="line">       <span class="keyword">return</span> el.getAttribute(<span class="string">'data-'</span>+name)</span><br><span class="line">     &#125;,</span><br><span class="line">     setData(el,name,val)&#123;</span><br><span class="line">       el.setAttribute(<span class="string">'data-'</span>+name,val)</span><br><span class="line">     &#125;,</span><br><span class="line">     setPlaceHolder(cmtEle)&#123;</span><br><span class="line">      <span class="keyword">if</span> (CONFIG.replyType==<span class="string">'div'</span>) &#123;</span><br><span class="line">        <span class="comment">// div+css下不能动态更新placeholder</span></span><br><span class="line">        cmtEle.setAttribute(<span class="string">'placeholder'</span>, <span class="string">'回复@'</span>+<span class="keyword">this</span>.placeholder+<span class="string">':'</span>)</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">       cmtEle.placeholder = <span class="string">'回复@'</span>+<span class="keyword">this</span>.placeholder+<span class="string">':'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     checkInput(cmtEle)&#123;</span><br><span class="line">       <span class="keyword">return</span> CONFIG.cmtType==<span class="string">'div'</span>? cmtEle.innerHTML.trim().length : cmtEle.value.trim().length;</span><br><span class="line">     &#125;,</span><br><span class="line">     setFocus(cmtEle)&#123;</span><br><span class="line">       cmtEle.focus();</span><br><span class="line">       <span class="keyword">if</span> (CONFIG.cmtType==<span class="string">'div'</span>) &#123;</span><br><span class="line">         <span class="keyword">let</span> range = win.getSelection();</span><br><span class="line">         range.selectAllChildren(cmtEle);</span><br><span class="line">         range.collapseToEnd();</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     safeTxt(con)&#123;</span><br><span class="line">      <span class="keyword">return</span> con.replace(<span class="regexp">/&lt;/ig</span>, <span class="string">'&amp;lt;'</span>).replace(<span class="regexp">/&gt;/ig</span>, <span class="string">'&amp;gt;'</span>)</span><br><span class="line">     &#125;,</span><br><span class="line">     getContent(cmtEle) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">this</span>.getCleanText(cmtEle)</span><br><span class="line">         .replace(<span class="regexp">/&lt;/ig</span>, <span class="string">'&amp;lt;'</span>)</span><br><span class="line">         .replace(<span class="regexp">/&gt;/ig</span>, <span class="string">'&amp;gt;'</span>);</span><br><span class="line">     &#125;,</span><br><span class="line">     randomID(prefix) &#123;</span><br><span class="line">       <span class="keyword">return</span> prefix + <span class="built_in">Math</span>.random().toString(<span class="number">32</span>).slice(<span class="number">2</span>);</span><br><span class="line">     &#125;,</span><br><span class="line">     stripTags: <span class="function"><span class="keyword">function</span>(<span class="params">el, tagName</span>) </span>&#123;</span><br><span class="line">       <span class="keyword">let</span> els = el.getElementsByTagName(tagName.toUpperCase());</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; els.length; i++) &#123;</span><br><span class="line">         <span class="keyword">while</span> (els[i].firstChild)</span><br><span class="line">           els[i].parentNode.insertBefore(els[i].removeChild(els[i].firstChild), els[i]);</span><br><span class="line">         els[i].parentNode.removeChild(els[i--]);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     getCleanText(cmtEle) &#123;</span><br><span class="line">       <span class="keyword">let</span> ele = cmtEle;</span><br><span class="line">       <span class="keyword">let</span> clone = ele.cloneNode(<span class="literal">true</span>);</span><br><span class="line">       <span class="keyword">let</span> _v = <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">if</span>(CONFIG.cmtType==<span class="string">'div'</span>)&#123;</span><br><span class="line">         clone.innerHTML = <span class="keyword">this</span>.html2txt(clone.innerHTML);</span><br><span class="line">         <span class="keyword">this</span>.stripTags(clone, <span class="string">'*'</span>);</span><br><span class="line">         _v = clone.innerHTML.replace(<span class="regexp">/(?:\s|&amp;nbsp;)*$/g</span>, <span class="string">''</span>);</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         clone.value = <span class="keyword">this</span>.html2txt(clone.value);</span><br><span class="line">         <span class="keyword">this</span>.stripTags(clone, <span class="string">'*'</span>);</span><br><span class="line">         _v = clone.value.replace(<span class="regexp">/(?:\s|&amp;nbsp;)*$/g</span>, <span class="string">''</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> _v;</span><br><span class="line">     &#125;,</span><br><span class="line">     html2txt(html) &#123;</span><br><span class="line">       <span class="keyword">let</span> res = html.replace(<span class="regexp">/&amp;nbsp;/igm</span>, <span class="string">' '</span>)</span><br><span class="line">         .replace(<span class="regexp">/(?:&lt;br\s*\\?&gt;)+/igm</span>, <span class="string">'\n'</span>)</span><br><span class="line">         .replace(<span class="regexp">/&lt;div&gt;(.*?)&lt;\/div&gt;/igm</span>, <span class="string">"\n$1"</span>)</span><br><span class="line">         .replace(<span class="regexp">/&lt;p&gt;(.*?)&lt;\/p&gt;/igm</span>, <span class="string">"\n$1"</span>);</span><br><span class="line">       <span class="keyword">return</span> res;</span><br><span class="line">     &#125;,</span><br><span class="line">     clearCmt(cmtEle)&#123;</span><br><span class="line">       <span class="keyword">if</span> (CONFIG.cmtType==<span class="string">'div'</span>) &#123;</span><br><span class="line">         cmtEle.innerHTML = <span class="string">''</span></span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         cmtEle.value = <span class="string">''</span></span><br><span class="line">       &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     renderCmt(configObj)&#123;</span><br><span class="line">       <span class="keyword">let</span> ret = configObj.ret,</span><br><span class="line">         newInsert = configObj.newInsert;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">let</span> targetFloor = ret.get(<span class="string">'targetFloor'</span>),</span><br><span class="line">         hasTargetFloor =!!targetFloor,</span><br><span class="line">         _objectId = ret.get(<span class="string">'objectId'</span>),  <span class="comment">//留言id</span></span><br><span class="line">         con = <span class="built_in">decodeURIComponent</span>(ret.get(<span class="string">'comment'</span>)),</span><br><span class="line">         _floor = ret.cid.split(<span class="string">'c'</span>)[<span class="number">1</span>],</span><br><span class="line">         <span class="comment">// 昵称,个人网址要记得防XSS</span></span><br><span class="line">         _email = ret.get(<span class="string">'email'</span>),</span><br><span class="line">         _nick = <span class="keyword">this</span>.safeTxt(ret.get(<span class="string">'nick'</span>)),</span><br><span class="line">         _link = ret.get(<span class="string">'link'</span>),</span><br><span class="line">         _time = Tool.formatTime(ret.get(<span class="string">'createdAt'</span>));</span><br><span class="line"></span><br><span class="line">       <span class="keyword">let</span> _con = <span class="string">''</span>, tpl = <span class="string">''</span>,avatarUrl=<span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!!_email) &#123;</span><br><span class="line">        avatarUrl =CONFIG.avatarUrl+<span class="keyword">this</span>.MD5(_email)+<span class="string">'?s=50&amp;d=identicon'</span>;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        avatarUrl = CONFIG.avatarUrl</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (hasTargetFloor) &#123;</span><br><span class="line">         _con = <span class="string">'&lt;i&gt;@'</span>+<span class="keyword">this</span>.cache[targetFloor].get(<span class="string">'nick'</span>)</span><br><span class="line">            +<span class="string">' #'</span>+<span class="keyword">this</span>.cache[targetFloor].cid.split(<span class="string">'c'</span>)[<span class="number">1</span>]</span><br><span class="line">            +<span class="string">' &lt;/i&gt;'</span>+con;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         _con = con;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       tpl = TPL.cmtItemTpl()</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;objectId&#125;&#125;/g</span>,_objectId)</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;floor&#125;&#125;/g</span>,_floor)</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;userName&#125;&#125;/g</span>,_nick)</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;userCenter&#125;&#125;/g</span>,(!!_link?<span class="keyword">this</span>.safeTxt(_link):<span class="string">'javascript:;'</span>))</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;createTime&#125;&#125;/g</span>,(newInsert?<span class="string">'刚刚'</span>:_time))</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;cmtData&#125;&#125;/g</span>,_con)</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;avatarUrl&#125;&#125;/g</span>,avatarUrl)</span><br><span class="line"></span><br><span class="line">       <span class="keyword">let</span> ele = doc.createElement(<span class="string">'li'</span>);</span><br><span class="line">       ele.classList =<span class="string">'cmt-item'</span>;</span><br><span class="line">       ele.innerHTML = tpl;</span><br><span class="line">       <span class="keyword">return</span> ele;</span><br><span class="line">     &#125;,</span><br><span class="line">     getAllComments(cb)&#123;</span><br><span class="line">       <span class="keyword">let</span> query = <span class="keyword">new</span> AV.Query(CONFIG.dataBase);</span><br><span class="line">       <span class="comment">// 根据页面URL(或者页面标题)来查找对应的评论</span></span><br><span class="line">       query.equalTo(<span class="string">'url'</span>, cmtDataObj[<span class="string">'url'</span>]);</span><br><span class="line">       <span class="keyword">if</span> (CONFIG.sort) &#123;</span><br><span class="line">         query.descending(<span class="string">'createdAt'</span>);  <span class="comment">//从新到旧</span></span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         query.ascending(<span class="string">'createdAt'</span>);  <span class="comment">//从旧到新</span></span><br><span class="line">       &#125;</span><br><span class="line">       query.find().then(<span class="function">(<span class="params">ret</span>)=&gt;</span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.setCache(ret);</span><br><span class="line">         <span class="keyword">this</span>.setCmtNum();</span><br><span class="line">         cb &amp;&amp; cb(ret)</span><br><span class="line">       &#125;)</span><br><span class="line">     &#125;,</span><br><span class="line">     setCache(ret)&#123;</span><br><span class="line">       <span class="keyword">this</span>.cache = &#123;&#125;;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; ret.length; i++) &#123;</span><br><span class="line">         <span class="keyword">this</span>.cache[ret[i].id] = ret[i];</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     updateCache(obj)&#123;</span><br><span class="line">       <span class="keyword">this</span>.cache[obj.id] = obj;</span><br><span class="line">       <span class="keyword">this</span>._len = <span class="built_in">Object</span>.getOwnPropertyNames(<span class="keyword">this</span>.cache).length;</span><br><span class="line">     &#125;,</span><br><span class="line">     renderAllCmt()&#123;</span><br><span class="line">       <span class="keyword">this</span>.getAllComments(<span class="function">(<span class="params">ret</span>)=&gt;</span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (CONFIG.replyType==<span class="string">'normal'</span>) &#123;</span><br><span class="line">           <span class="keyword">let</span> fragment = doc.createDocumentFragment();</span><br><span class="line"></span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; ret.length; i++) &#123;</span><br><span class="line">             fragment.appendChild(<span class="keyword">this</span>.renderCmt(&#123;</span><br><span class="line">               ret:ret[i],</span><br><span class="line">               newInsert:<span class="literal">false</span></span><br><span class="line">             &#125;));</span><br><span class="line">           &#125;</span><br><span class="line">           JcmtList.appendChild(fragment);</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;)</span><br><span class="line">     &#125;,</span><br><span class="line">     renderNewCmt(ret)&#123;</span><br><span class="line">       <span class="keyword">let</span> li = <span class="keyword">this</span>.renderCmt(&#123;</span><br><span class="line">         ret:ret,</span><br><span class="line">         newInsert:<span class="literal">true</span></span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 判断插入位置</span></span><br><span class="line">       <span class="function"><span class="keyword">function</span> <span class="title">normalSort</span>(<span class="params">parent</span>)</span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (CONFIG.sort) &#123;</span><br><span class="line">           parent.prepend(li);</span><br><span class="line">         &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           parent.appendChild(li);</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       normalSort(JcmtList);</span><br><span class="line">     &#125;,</span><br><span class="line">     setCmtNum()&#123;</span><br><span class="line">       <span class="keyword">let</span> ele = doc.querySelector(<span class="string">'.cmt-count'</span>)</span><br><span class="line">       <span class="keyword">this</span>._len = <span class="built_in">Object</span>.getOwnPropertyNames(<span class="keyword">this</span>.cache).length;</span><br><span class="line">       ele.innerHTML = <span class="keyword">this</span>._len;</span><br><span class="line">     &#125;,</span><br><span class="line">     saveComment(sucess,fail)&#123;</span><br><span class="line">       <span class="keyword">let</span> av = AV.Object.extend(CONFIG.dataBase);</span><br><span class="line">       <span class="keyword">let</span> instance = <span class="keyword">new</span> av();</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> cmtDataObj) &#123;</span><br><span class="line">         <span class="keyword">if</span> (cmtDataObj.hasOwnProperty(i)) &#123;</span><br><span class="line">           <span class="keyword">let</span> _v = cmtDataObj[i];</span><br><span class="line">           instance.set(i, _v);</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       instance.save().then(<span class="function">(<span class="params">ret</span>)=&gt;</span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.updateCache(ret);</span><br><span class="line">         sucess &amp;&amp; sucess(ret);</span><br><span class="line">       &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">         fail &amp;&amp; fail(error);</span><br><span class="line">       &#125;);</span><br><span class="line">     &#125;,</span><br><span class="line">     postData(configObj)&#123;</span><br><span class="line">       <span class="keyword">let</span> cmtEle = configObj.cmtEle,</span><br><span class="line">         sucess = configObj.sucess,</span><br><span class="line">         fail = configObj.fail;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">let</span> len = <span class="keyword">this</span>.checkInput(cmtEle)</span><br><span class="line">       <span class="keyword">if</span> (len==<span class="number">0</span>) &#123;</span><br><span class="line">         alert(<span class="string">'请输入评论'</span>);</span><br><span class="line">         <span class="keyword">this</span>.setFocus(cmtEle) <span class="comment">//评论框</span></span><br><span class="line">         <span class="keyword">return</span> !<span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">let</span> html = <span class="keyword">this</span>.getContent(cmtEle);</span><br><span class="line"></span><br><span class="line">       cmtDataObj.comment = html; <span class="comment">//挂载到数据包</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">// 读取最后的用户数据</span></span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; CONFIG.lsArr.length; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> v = localStorage[CONFIG.lsPrefix+CONFIG.lsArr[i]];</span><br><span class="line">        <span class="keyword">if</span> (!!v) &#123;</span><br><span class="line">           cmtDataObj[CONFIG.lsArr[i]] = v;</span><br><span class="line">        &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       cmtEle==JmainCmt &amp;&amp; (cmtDataObj.targetFloor=<span class="string">''</span>); <span class="comment">// 主评论没有目标楼层</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.saveComment(<span class="function">(<span class="params">ret</span>)=&gt;</span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.renderNewCmt(ret);</span><br><span class="line">         <span class="keyword">this</span>.clearCmt(cmtEle);</span><br><span class="line">         <span class="keyword">this</span>.setCmtNum();</span><br><span class="line">         sucess &amp;&amp; sucess()</span><br><span class="line">       &#125;,(error)=&gt;&#123;</span><br><span class="line">         <span class="built_in">console</span>.log(error)</span><br><span class="line">         fail &amp;&amp; fail()</span><br><span class="line">       &#125;);</span><br><span class="line">     &#125;,</span><br><span class="line">     insertReplyForm(wrap)&#123;</span><br><span class="line">       <span class="keyword">this</span>.lastId = wrap.id;</span><br><span class="line">       wrap.appendChild(<span class="keyword">this</span>.replyForm);</span><br><span class="line">       <span class="keyword">this</span>.setData(wrap,<span class="string">'status'</span>,<span class="string">'1'</span>);</span><br><span class="line">       <span class="keyword">this</span>.setPlaceHolder(JreplyCmt);</span><br><span class="line">       <span class="keyword">this</span>.replyForm.style.display = <span class="string">'block'</span>;</span><br><span class="line">       <span class="keyword">this</span>.setFocus(JreplyCmt);</span><br><span class="line">       cmtDataObj.targetFloor = <span class="keyword">this</span>.lastId;</span><br><span class="line">     &#125;,</span><br><span class="line">     removeReplyForm(cb)&#123;</span><br><span class="line">       <span class="keyword">let</span> lastTarget =  doc.getElementById(<span class="keyword">this</span>.lastId)</span><br><span class="line">       <span class="keyword">this</span>.setData(lastTarget,<span class="string">'status'</span>,<span class="string">'0'</span>)</span><br><span class="line">       <span class="keyword">this</span>.replyForm.style.display = <span class="string">'none'</span>;</span><br><span class="line">       doc.getElementById(<span class="keyword">this</span>.lastId).removeChild(<span class="keyword">this</span>.replyForm);</span><br><span class="line">       cb &amp;&amp; cb()</span><br><span class="line">     &#125;,</span><br><span class="line">     toggleReplyForm(wrap,isShowed)&#123;</span><br><span class="line">       <span class="keyword">if</span> (isShowed == <span class="string">'1'</span>) &#123;</span><br><span class="line">         <span class="keyword">this</span>.setData(wrap,<span class="string">'status'</span>,<span class="string">'0'</span>)</span><br><span class="line">         <span class="keyword">this</span>.replyForm.style.display = <span class="string">'none'</span>;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.setData(wrap,<span class="string">'status'</span>,<span class="string">'1'</span>)</span><br><span class="line">         <span class="keyword">this</span>.setPlaceHolder(JreplyCmt)</span><br><span class="line">         <span class="keyword">this</span>.replyForm.style.display = <span class="string">'block'</span>;</span><br><span class="line">         <span class="keyword">this</span>.setFocus(JreplyCmt);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     fetchUserInfo()&#123;</span><br><span class="line">      <span class="keyword">let</span> lsArr = CONFIG.lsArr;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; lsArr.length; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> ipt = doc.getElementById(<span class="string">'J'</span>+lsArr[i]);</span><br><span class="line">        ipt.value = localStorage.getItem(CONFIG.lsPrefix+lsArr[i]);</span><br><span class="line">      &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     bindEvent()&#123;</span><br><span class="line">       <span class="keyword">let</span> clickHandler = <span class="function">(<span class="params">e</span>)=&gt;</span>&#123;</span><br><span class="line">         <span class="keyword">let</span> target = e.target</span><br><span class="line">         <span class="keyword">let</span> eventType = <span class="keyword">this</span>.getData(target,<span class="string">'event'</span>);</span><br><span class="line">         <span class="keyword">switch</span>(eventType)&#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">'postCmt'</span> :</span><br><span class="line">             <span class="keyword">this</span>.postData(&#123;</span><br><span class="line">               cmtEle: JmainCmt,</span><br><span class="line">               sucess:<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;,</span><br><span class="line">               fail:<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;</span><br><span class="line">             &#125;);</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">'postReply'</span> :</span><br><span class="line">             <span class="keyword">this</span>.postData(&#123;</span><br><span class="line">               cmtEle:JreplyCmt,</span><br><span class="line">               sucess:<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">                 <span class="keyword">this</span>.toggleReplyForm(doc.getElementById(<span class="keyword">this</span>.lastId),<span class="string">'1'</span>);</span><br><span class="line">               &#125;,</span><br><span class="line">               fail:<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;</span><br><span class="line">             &#125;);</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">'reply'</span> :</span><br><span class="line">             <span class="keyword">let</span> targetId = <span class="keyword">this</span>.getData(target,<span class="string">'id'</span>); <span class="comment">// 按钮存储objectId</span></span><br><span class="line">             <span class="keyword">let</span> wrap = doc.getElementById(targetId),</span><br><span class="line">               isShowed = <span class="keyword">this</span>.getData(wrap,<span class="string">'status'</span>);</span><br><span class="line">             <span class="keyword">this</span>.placeholder = <span class="keyword">this</span>.getData(wrap,<span class="string">'placeholder'</span>);</span><br><span class="line"></span><br><span class="line">             <span class="keyword">if</span> (<span class="keyword">this</span>.lastId==<span class="literal">null</span>) &#123;</span><br><span class="line">               <span class="keyword">this</span>.generateReplyForm(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">                 <span class="keyword">this</span>.insertReplyForm(wrap);</span><br><span class="line">               &#125;);</span><br><span class="line">             &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               <span class="keyword">if</span> (<span class="keyword">this</span>.lastId==wrap.id) &#123;</span><br><span class="line">                 <span class="keyword">this</span>.toggleReplyForm(wrap,isShowed)</span><br><span class="line">               &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                 <span class="keyword">this</span>.removeReplyForm(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">                   <span class="keyword">this</span>.insertReplyForm(wrap);</span><br><span class="line">                   <span class="keyword">this</span>.toggleReplyForm(wrap,isShowed)</span><br><span class="line">                 &#125;);</span><br><span class="line">               &#125;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">default</span>:</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> keyUpHandler = <span class="function">(<span class="params">e</span>)=&gt;</span>&#123;</span><br><span class="line">        e.preventDefault();</span><br><span class="line">        <span class="keyword">let</span> target = e.target;</span><br><span class="line">        <span class="keyword">let</span> itemName = <span class="keyword">this</span>.getData(target,<span class="string">'name'</span>);</span><br><span class="line">        <span class="keyword">let</span> v =  target.value.trim();</span><br><span class="line">        <span class="keyword">switch</span> (itemName) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'nick'</span>:</span><br><span class="line">            localStorage.setItem(CONFIG.lsPrefix+<span class="string">'nick'</span>, v);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'email'</span>:</span><br><span class="line">            localStorage.setItem(CONFIG.lsPrefix+<span class="string">'email'</span>, v);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'link'</span>:</span><br><span class="line">            localStorage.setItem(CONFIG.lsPrefix+<span class="string">'link'</span>, v);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       doc.body.addEventListener(<span class="string">'click'</span>,clickHandler,<span class="literal">false</span>);</span><br><span class="line">       Jnick.addEventListener(<span class="string">'keyup'</span>,keyUpHandler,<span class="literal">false</span>);</span><br><span class="line">       Jemail.addEventListener(<span class="string">'keyup'</span>,keyUpHandler,<span class="literal">false</span>);</span><br><span class="line">       Jlink.addEventListener(<span class="string">'keyup'</span>,keyUpHandler,<span class="literal">false</span>);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   win.CMT = CMT;</span><br><span class="line">&#125;)(<span class="built_in">window</span>,<span class="built_in">document</span>);</span><br></pre></td></tr></table></figure></p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>把手头的活干完, 再继续完善Todo吧</p>

  </div>

</article>


  <nav id="pagenavi">
    
    <a href="/2018/11/13/curl/" class="prev">上一篇：常用CURL命令</a>
    
    
    <a href="/2017/05/31/安卓微信视频播放全屏问题处理/" class="next">下一篇：【奇技淫巧】安卓微信视频播放全屏问题处理</a>
    
  </nav>

        </div>
        
        
          <div class="post-comments" id="Jcmt">
            <h1 class="post-comments-title">访客评论</h1>
            <div id="Jcomment"></div>
          </div>
        
      </div>
      <footer id="footer" class="inner">
        © 2020 - 测试狗 -
        <span id="busuanzi_container_site_pv">PV <span id="busuanzi_value_site_pv"></span></span>
        <p>Powered by <a href="https://hexo.io/">Hexo</a> & <a href="https://github.com/thinkerchan/hexo-theme-greyshade">GreyShade</a></p>
      </footer>
    </div>
  </div>
  
  <script>
    let mod ={
      timePrefix:'t-',
      expire:1000*60*60,
      load:function(libName,libUrl,cb){
        let aval = (new Date).getTime() - localStorage.getItem(this.timePrefix+libName) < this.expire;
        let libStr = localStorage.getItem(libName)
        if (aval && libStr) {
          this.parseAndInsert(libStr)
          cb && cb(libStr);
        }else{
          this.ajax(libUrl,(str)=>{
            localStorage.setItem(libName, str)
            localStorage.setItem(this.timePrefix+libName, (new Date).getTime())
            this.parseAndInsert(str)
            cb && cb(str);
          })
        }
      },
      parseAndInsert(rawStr) {
        let script = document.createElement('script')
        script.innerHTML = rawStr
        document.body.appendChild(script)
      },
      ajax:function(url,cb){
        let xhr = new XMLHttpRequest;
        xhr.open('get', url, true)
        xhr.send();
        xhr.onreadystatechange = function () {
          if (xhr.readyState == 4 && xhr.status == 200) {
            cb && cb(xhr.responseText)
          }else{
            console.log(xhr.readyState,xhr.status);
          }
        }
      },
      genCmt(){
        window.Valine && new Valine({
          el: '#Jcomment',
          appId: 'XPJzs0FfufkFfuBjbJraqhbo-gzGzoHsz',
          appKey: 'QoS0zL4Y2xTDviitGOPkvCGv',
          notify: true,
          verify: false,
          avatar: 'mm',
          pageSize: '10',
          placeholder: 'Valine+Leancloud提供评论'
        })
      }
    }

    mod.load('lib-av', 'https://cdn1.lncld.net/static/js/3.0.4/av-min.js', () => {
      mod.load('lib-cmt', 'https://unpkg.com/valine@1.4.14/dist/Valine.min.js',()=>{
        let t = setTimeout(() => {
          mod.genCmt()
          clearTimeout(t)
          t = null;
        }, 100);
      })
    })
  </script>
  
  <script async defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  
  <script async defer src="https://s5.cnzz.com/z_stat.php?id=1276809529&web_id=1276809529"></script>
  
</body>
</html>