<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <link rel="dns-prefetch" href="https://thinkerchan.com">
  
  <title>ã€å¿«é€Ÿæ•™ç¨‹ã€‘ç¼–å†™ä¸€ä¸ªJSè¯„è®ºç»„ä»¶ | æµ‹è¯•ç‹—</title>
  <meta name="author" content="æµ‹è¯•ç‹—">
  
  <meta name="description" content="ğŸ¶">
  
  
  <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

  <meta property="og:title" content="ã€å¿«é€Ÿæ•™ç¨‹ã€‘ç¼–å†™ä¸€ä¸ªJSè¯„è®ºç»„ä»¶"/>
  <meta property="og:site_name" content="æµ‹è¯•ç‹—"/>

  
    <meta property="og:image" content=""/>
  

  <link rel="alternate" href="/atom.xml" title="æµ‹è¯•ç‹—" type="application/atom+xml">

  <link rel="preload" as="style" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

  <link rel="icon" class="js-site-favicon" type="image/svg+xml" href="https://github.githubassets.com/favicons/favicon.svg">
  <link href="https://unpkg.com" rel="dns-prefetch" />
  <link href="https://busuanzi.ibruce.info" rel="dns-prefetch" />
  <link href="https://cdn1.lncld.net" rel="dns-prefetch" />
  
  <link href="https://xpjzs0ff.api.lncld.net" rel="dns-prefetch" />
  
</head>

<body>
  <div class="container">
    <div class="left-col" style="background-image:url('https://tva1.sinaimg.cn/large/007S8ZIlly1giq5k8ty3tj306y0zkdix.jpg')">
      <div class="intrude-less">
        <header id="header" class="inner">
          <a href="/">
            <div class="profilepic"><img class="avatar" src='https://tva1.sinaimg.cn/large/007S8ZIlly1giq5t0agwnj30bf0b4jrk.jpg'></div>
          </a>
          <div class="author-name"><a href="/">æµ‹è¯•ç‹—</a></div>
          <p class="aboutme">ğŸ¶</p>
          <nav id="main-nav">
            <ul class="main">
              
              <li>
                
                  <a href="/archives">å½’æ¡£</a>
                
              </li>
              
              <li>
                
                  <a href="/categories">ä¸“é¢˜</a>
                
              </li>
              
              <li>
                
                  <a href="/friendlinks">å‹é“¾</a>
                
              </li>
              
              <li>
                
                  <a href="/life">å…³äº</a>
                
              </li>
              
              <li>
                
                  <a href="/search">æœç´¢</a>
                
              </li>
              
            </ul>
          </nav>
          <nav id="sub-nav">
            <div class="social">
              
              <a class="twitter" href="https://twitter.com/thinkerchan" title="Twitter">Twitter</a>
              
              
              
              <a class="github" href="https://github.com/thinkerchan" title="Github">Github</a>
              
              
              <a class="yuque" href="https://yuque.com/testdog" title="è¯­é›€">è¯­é›€</a>
              

              
              <a class="rss" href="/atom.xml" title="RSS">RSS</a>
              
            </div>
          </nav>
        </header>
      </div>
    </div>
    <div class="mid-col">
      <div class="mid-col-container">
        <div id="content" class="inner">
          <article class="post">

  
    <div class="meta">
      
<div class="date">

<time datetime="2018-09-30T00:33:00.000Z"
      
      data-updated="true"
       itemprop="datePublished">
  2018-09-30
</time>





</div>

    </div>
  
  <h1 class="title" itemprop="name">ã€å¿«é€Ÿæ•™ç¨‹ã€‘ç¼–å†™ä¸€ä¸ªJSè¯„è®ºç»„ä»¶</h1>
  <div class="entry-content" itemprop="articleBody">
    
    <div class="post-toc">
      <div class="toc-title">TOC</div>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#å‰è¨€"><span class="toc-number">1.</span> <span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ•ˆæœ"><span class="toc-number">2.</span> <span class="toc-text">æ•ˆæœ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å¤§æ¦‚éœ€æ±‚"><span class="toc-number">3.</span> <span class="toc-text">å¤§æ¦‚éœ€æ±‚</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æºç "><span class="toc-number">4.</span> <span class="toc-text">æºç </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å…¶ä»–"><span class="toc-number">5.</span> <span class="toc-text">å…¶ä»–</span></a></li></ol>
    </div>
    
    <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å½“åˆåœ¨è€ä¸œå®¶æ¬ç –çš„æ—¶å€™, è´Ÿè´£è¯„è®ºç»„ä»¶è¿™ä¸€å—çš„å‰ç«¯é‡æ„ã€‚åˆšå¥½17å¹´å¹´ä¸­é‚£ä¼š, å›½å®¶æ³•å¾‹è¦æ±‚æ‰€æœ‰èƒ½å¤Ÿå‘è¡¨è¨€è®ºçš„åœ°æ–¹, éƒ½å¾—æ¥å…¥å®ååˆ¶, äºæ˜¯ç”¨äº†å¾ˆä¹…çš„â€å¤šè¯´â€,ä¹Ÿä¸å…ä¸­æª,æŒ‚äº†ã€‚æœ¬æ¥æƒ³ç€è‡ªå·±è¦ä¸ç”¨å‰åç«¯éƒ½å†™äº†, å¼„ä¸€å¥—å¼€æºçš„è¯„è®ºç³»ç»Ÿå¥½äº†,ç»“æœä»ç¦»èŒååˆ°ç°åœ¨ç§ç§å¿™æ´»éƒ½æ²¡å†™å®Œ(è‡ªæˆ‘æ£€è®¨ä¸­)ã€‚</p>
<p>åˆšå¥½å‰æ®µæ—¶é—´ç”¨åˆ°<a href="https://leancloud.cn/" target="_blank" rel="noopener">LeanCloud</a>è¿™ä¸ªè¿˜ä¸é”™çš„äº§å“(çœŸæ²¡æ‰“å¹¿å‘Š), ç»§è€Œå‘ç°äº†<a href="https://valine.js.org/" target="_blank" rel="noopener">Valine</a>è¿™ä¸ªè¯„è®ºç»„ä»¶, æ¥å…¥äº†LeanCloudã€‚</p>
<p>é‚£æˆ‘å¹²å˜›è¿˜è‡ªå·±å†™è¯„è®ºç³»ç»Ÿï¼ˆåæ­£åç«¯æ²¡å†™å®Œï¼‰ï¼Ÿç›´æ¥ç”¨Valineä¸é¦™å—ã€‚ä¸è¿‡æ—¢ç„¶ä¹Ÿå†™äº†ä¸€éƒ¨åˆ†ï¼Œé‚£ä¹Ÿæ”¹é€ ä¸‹ï¼Œç®—æ˜¯ä¸€ä¸ªå…¥é—¨çº§åˆ«çš„è¯„è®ºç»„ä»¶ç¼–å†™æ•™ç¨‹å§.</p>
<p>å¦å¤–è¯´ä¸€å¥, Valineå·²ç»å¾ˆå®Œå–„äº†, åŒ…æ‹¬åé¢æœ‰äººå®Œå–„<a href="https://github.com/panjunwen/Valine-Admin" target="_blank" rel="noopener">Valine-admin</a>è¿™æ ·çš„è¾…åŠ©å·¥å…·. è¯´è¿™äº›ä¹Ÿå¹¶éä¸å»ºè®®å¤§å®¶é‡å¤é€ è½®å­. åªä¸è¿‡å¦‚æœæŒæ¡äº†è¿™ä¸ªæŠ€èƒ½ï¼Œå°±ä¸è¦å†åšé‡å¤çš„äº‹æƒ…ã€‚</p>
<h2 id="æ•ˆæœ"><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h2><p>æ—¢ç„¶æ˜¯demo,é‚£åªç”¨ES6å’Œcss3å¼€å‘, åªèƒ½ç”¨é«˜çº§æµè§ˆå™¨<a href="https://thinkerchan.github.io/cmt/" target="_blank" rel="noopener">æŸ¥çœ‹</a></p>
<h2 id="å¤§æ¦‚éœ€æ±‚"><a href="#å¤§æ¦‚éœ€æ±‚" class="headerlink" title="å¤§æ¦‚éœ€æ±‚"></a>å¤§æ¦‚éœ€æ±‚</h2><p>å› ä¸ºåªæœ‰LeanCloud,æ²¡æœ‰è‡ªå·±çš„åå°, æ‰€ä»¥æœ‰äº›åŠŸèƒ½æ²¡æ³•åš(å…¶å®ä¹Ÿä¸æ˜¯æ²¡æ³•åš, åªæ˜¯æ•ˆæœä¸å¥½)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@k è¯„è®ºåŸå‹</span><br><span class="line"></span><br><span class="line">ä¸»è¦éƒ¨åˆ†</span><br><span class="line">1.è¯„è®ºæ¡†å¤ç”¨ //âˆš</span><br><span class="line">2.å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œè½¬ä¹‰ //âˆš</span><br><span class="line">3.è¯„è®ºæ•°æ®ç»“æ„å¤ç”¨ //âˆš</span><br><span class="line">4.å¼‚æ­¥åŠ è½½æ ·å¼è¡¨  // âˆš</span><br><span class="line">5.Ajax  // å› ä¸ºç”¨äº†leancloud,æ‰€ä»¥ç›´æ¥ç”¨å®ƒçš„SDK</span><br><span class="line">6.ç•™è¨€æ’åºå¯é€‰ // Ã— ç›´æ¥ä»æ—§åˆ°æ–°</span><br><span class="line">7. åŸºäºlocalstorageå­˜å‚¨ç½‘å‹çš„æ˜µç§°/é‚®ç®±/ç½‘å€</span><br><span class="line">8. md5æ‹¼æ¥é‚®ç®±ç”Ÿæˆå¤´åƒ //åŸºäºgavatar</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">TODO</span><br><span class="line">1. ç•™è¨€ç‚¹èµåŠŸèƒ½ //éé™å®šæ¬¡æ•°(åˆ é™¤cookieä¾ç„¶å¯ä»¥ç‚¹èµ)</span><br><span class="line">2. ç”¨æˆ·ç™»å½•/æ³¨å†Œ  // è¦åšå—?</span><br><span class="line">3. éªŒè¯ç   //éœ€è¦åç«¯é…åˆ</span><br><span class="line">5.è¡¨æƒ…å¤„ç†(ç±»ä¼¼æ–°æµªå¾®åšå¤„ç†æ–¹å¼æ¯”è¾ƒåˆç†) //âœ˜</span><br><span class="line">6.æ¥¼å±‚åµŒå¥—  //ç±»ä¼¼biliili</span><br><span class="line">7.åˆ†é¡µ</span><br><span class="line">8.æ¥¼å±‚IDå¤„ç† // normalåˆ™ä¸éœ€è¦å¤„ç†, æ¥¼å±‚åµŒå¥—åˆ™è¦è¿‡æ»¤ä¸å«æœ‰targetFloorçš„cid</span><br></pre></td></tr></table></figure>
<h2 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h2><p>éº»é›€è™½å°ï¼Œäº”è„ä¿±å…¨ã€‚çœ‹äº†ä¹‹åä¿è¯ä½ ä¹Ÿèƒ½å†™ä¸€ä¸ªValineäº†ï¼ˆæ­£ç»è„¸ï¼‰ã€‚<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">;(<span class="function"><span class="keyword">function</span>(<span class="params">win,doc</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// https://leancloud.cn/docs/leanstorage_guide-js.html</span></span><br><span class="line">   <span class="keyword">let</span> CONFIG = &#123;</span><br><span class="line">     dataBase:<span class="string">'CMT'</span>, <span class="comment">//åˆ›å»ºä¸€ä¸ªè¡¨å</span></span><br><span class="line">     avatarUrl:<span class="string">'https://cdn.v2ex.com/gravatar/'</span>,  <span class="comment">//é»˜è®¤å¤´åƒ +md5(email)å¯åšæ ‡è¯†</span></span><br><span class="line">     sort:<span class="literal">false</span>,  <span class="comment">//é»˜è®¤æ–°æ—§æ’åº</span></span><br><span class="line">     replyType: <span class="string">'normal'</span>,</span><br><span class="line">     cmtType:<span class="string">'textarea'</span>,  <span class="comment">//div, textarea</span></span><br><span class="line">     placeholder:<span class="string">"æ¬¢è¿çŒæ°´"</span>,</span><br><span class="line">     lsPrefix:<span class="string">'CMT'</span>,</span><br><span class="line">     lsArr:[<span class="string">'nick'</span>,<span class="string">'email'</span>,<span class="string">'link'</span>]</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// è¦å­˜çš„æ•°æ®ç»“æ„</span></span><br><span class="line">   <span class="keyword">let</span> cmtDataObj = &#123;</span><br><span class="line">      comment: <span class="string">''</span>,   <span class="comment">// è¯„è®ºå†…å®¹</span></span><br><span class="line">      nick: <span class="string">'æ¸¸å®¢'</span>,  <span class="comment">//æ˜µç§°</span></span><br><span class="line">      email: <span class="string">''</span>,  <span class="comment">//ç”¨æˆ·é‚®ç®±</span></span><br><span class="line">      link: <span class="string">''</span>,  <span class="comment">//ç”¨æˆ·ä¸»é¡µ</span></span><br><span class="line">      ua: navigator.userAgent,</span><br><span class="line">      url: win.location.pathname.replace(<span class="regexp">/index\.(html|htm)/</span>, <span class="string">''</span>),</span><br><span class="line">      captcha: <span class="number">0</span>,</span><br><span class="line">      like: <span class="number">0</span>,</span><br><span class="line">      dislike:<span class="number">0</span>,</span><br><span class="line">      targetFloor:<span class="string">''</span>  <span class="comment">//å­˜å‚¨å›å¤æ¥¼å±‚çš„ID</span></span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">// è¾…åŠ©æ¨¡å—</span></span><br><span class="line">   <span class="keyword">let</span> Tool = &#123;</span><br><span class="line">     formatDate(date,bool)&#123;</span><br><span class="line">       <span class="keyword">const</span> padWithZeros = <span class="function">(<span class="params">vNumber, width</span>) =&gt;</span> &#123;</span><br><span class="line">         <span class="keyword">let</span> numAsString = vNumber.toString();</span><br><span class="line">         <span class="keyword">while</span> (numAsString.length &lt; width) &#123;</span><br><span class="line">           numAsString = <span class="string">'0'</span> + numAsString;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> numAsString;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">let</span> vDay = padWithZeros(date.getDate(), <span class="number">2</span>);</span><br><span class="line">       <span class="keyword">let</span> vMonth = padWithZeros(date.getMonth() + <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">       <span class="keyword">let</span> vYear = padWithZeros(date.getFullYear(), <span class="number">2</span>);</span><br><span class="line">       <span class="keyword">if</span> (bool) &#123;</span><br><span class="line">         <span class="keyword">let</span> vH = date.getHours();</span><br><span class="line">         <span class="keyword">let</span> vM = date.getMinutes();</span><br><span class="line">         <span class="keyword">let</span> vS = date.getSeconds();</span><br><span class="line">         <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">s</span>)</span>&#123;</span><br><span class="line">           <span class="keyword">return</span> (<span class="string">''</span>+s).length ==<span class="number">1</span>? <span class="string">'0'</span>+s : s;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;vYear&#125;</span>-<span class="subst">$&#123;vMonth&#125;</span>-<span class="subst">$&#123;vDay&#125;</span> <span class="subst">$&#123;f(vH)&#125;</span>:<span class="subst">$&#123;f(vM)&#125;</span>:<span class="subst">$&#123;f(vS)&#125;</span>`</span>;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;vYear&#125;</span>-<span class="subst">$&#123;vMonth&#125;</span>-<span class="subst">$&#123;vDay&#125;</span>`</span>;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="comment">// æ ¼å¼åŒ–æ—¶é—´</span></span><br><span class="line">     formatTime(date)&#123;</span><br><span class="line">       <span class="keyword">let</span> serTime = date.getTime();</span><br><span class="line">       <span class="keyword">let</span> curTime = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</span><br><span class="line">       <span class="keyword">let</span> diff = curTime - serTime;</span><br><span class="line">       <span class="keyword">let</span> day = <span class="built_in">Math</span>.floor(diff / (<span class="number">24</span> * <span class="number">3600</span> * <span class="number">1000</span>));</span><br><span class="line">       <span class="keyword">if</span> (day === <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="keyword">let</span> remainMsFromeH = diff % (<span class="number">24</span> * <span class="number">3600</span> * <span class="number">1000</span>);</span><br><span class="line">         <span class="keyword">let</span> hour = <span class="built_in">Math</span>.floor(remainMsFromeH / (<span class="number">3600</span> * <span class="number">1000</span>));</span><br><span class="line">         <span class="keyword">if</span> (hour === <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">let</span> remainMsFromeM = remainMsFromeH % (<span class="number">3600</span> * <span class="number">1000</span>);</span><br><span class="line">           <span class="keyword">let</span> minute = <span class="built_in">Math</span>.floor(remainMsFromeM / (<span class="number">60</span> * <span class="number">1000</span>));</span><br><span class="line">           <span class="keyword">if</span> (minute === <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="keyword">let</span> remainMsFromeS = remainMsFromeM % (<span class="number">60</span> * <span class="number">1000</span>)</span><br><span class="line">             <span class="keyword">let</span> second = <span class="built_in">Math</span>.round(remainMsFromeS / <span class="number">1000</span>);</span><br><span class="line">             <span class="keyword">return</span> second + <span class="string">' ç§’å‰'</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> minute + <span class="string">' åˆ†é’Ÿå‰'</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> hour + <span class="string">' å°æ—¶å‰'</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (day &lt; <span class="number">1</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> day + <span class="string">' å¤©å‰'</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">this</span>.formatDate(date)</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// æ¨¡æ¿æ¨¡å—</span></span><br><span class="line">   <span class="keyword">let</span> TPL=&#123;</span><br><span class="line">     mainView()&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">         &lt;div class="cmt-area cmt-postcomment"&gt;</span></span><br><span class="line"><span class="string">           &lt;div class="cmt-area-hd"&gt;</span></span><br><span class="line"><span class="string">             &lt;div class="cmt-area-tit"&gt;ç½‘å‹è¯„è®º&lt;/div&gt;</span></span><br><span class="line"><span class="string">             &lt;div class="cmt-count-wrap"&gt;å…±æœ‰&lt;span class="cmt-count"&gt;0&lt;/span&gt;æ¡è¯„è®º&lt;/div&gt;</span></span><br><span class="line"><span class="string">           &lt;/div&gt;</span></span><br><span class="line"><span class="string">         &lt;/div&gt;</span></span><br><span class="line"><span class="string">         &lt;div class="cmt-content"&gt;</span></span><br><span class="line"><span class="string">           &lt;ul class="cmt-list" id="JcmtList"&gt;&lt;/ul&gt;</span></span><br><span class="line"><span class="string">         &lt;/div&gt;</span></span><br><span class="line"><span class="string">       `</span></span><br><span class="line">     &#125;,</span><br><span class="line">     cmtFormTpl(bool)&#123; <span class="comment">//è¯„è®ºæ¡†æ¨¡æ¿</span></span><br><span class="line">        <span class="comment">// div+contenteditable , é»˜è®¤è½¬ä¹‰ç”¨æˆ·è¾“å…¥ ,textareaç­‰,ä¸ä¼šè¢«è½¬ä¹‰,è¦è¿‡æ»¤</span></span><br><span class="line">       <span class="keyword">let</span> con = <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">if</span> (CONFIG.cmtType==<span class="string">'div'</span>) &#123;</span><br><span class="line">         con = <span class="string">'&lt;div class="cmt-main-txtarea" contenteditable id="&#123;&#123;cmtId&#125;&#125;" placeholder="'</span>+CONFIG.placeholder+<span class="string">'"&gt;&lt;/div&gt;'</span></span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         con = <span class="string">'&lt;textarea class="cmt-main-txtarea" placeholder="'</span>+CONFIG.placeholder+<span class="string">'" id="&#123;&#123;cmtId&#125;&#125;"&gt;&lt;/textarea&gt;'</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">let</span> hd = <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">if</span> (!bool) &#123;</span><br><span class="line">          hd =<span class="string">`&lt;div class="cmt-login-area"&gt;</span></span><br><span class="line"><span class="string">             &lt;input  class="cmt-login-ipt" placeholder="æ˜µ ç§°" id="Jnick" data-name="nick"/&gt;</span></span><br><span class="line"><span class="string">             &lt;input  class="cmt-login-ipt" placeholder="é‚® ç®±" id="Jemail" data-name="email"/&gt;</span></span><br><span class="line"><span class="string">             &lt;input  class="cmt-login-ipt" placeholder="ä¸ªäººç½‘ç«™" id="Jlink" data-name="link"/&gt;</span></span><br><span class="line"><span class="string">           &lt;/div&gt;`</span>;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          hd=<span class="string">''</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">         &lt;div class="cmt-area-bd"&gt;</span></span><br><span class="line"><span class="string">            <span class="subst">$&#123;hd&#125;</span></span></span><br><span class="line"><span class="string">           &lt;div class="cmt-main-txtarea-wrap"&gt;</span></span><br><span class="line"><span class="string">             <span class="subst">$&#123;con&#125;</span></span></span><br><span class="line"><span class="string">           &lt;/div&gt;</span></span><br><span class="line"><span class="string">         &lt;/div&gt;</span></span><br><span class="line"><span class="string">         &lt;div class="cmt-area-ft"&gt;</span></span><br><span class="line"><span class="string">           &lt;a  class="btn cmt-main-txtarea-sbmt-btn" data-event="&#123;&#123;eventType&#125;&#125;"&gt;&#123;&#123;btnTxt&#125;&#125;&lt;/a&gt;</span></span><br><span class="line"><span class="string">         &lt;/div&gt;</span></span><br><span class="line"><span class="string">       `</span></span><br><span class="line">     &#125;,</span><br><span class="line">     cmtItemTpl()&#123; <span class="comment">//è¯„è®ºæ•°æ®æ¨¡æ¿</span></span><br><span class="line">       <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">         &lt;div class="cmt-user-avatar"&gt;</span></span><br><span class="line"><span class="string">           &lt;a href="&#123;&#123;userCenter&#125;&#125;" class="user-center-link" target="_blank"&gt;</span></span><br><span class="line"><span class="string">             &lt;img class="user-avatar-img" src="&#123;&#123;avatarUrl&#125;&#125;"&gt;</span></span><br><span class="line"><span class="string">           &lt;/a&gt;</span></span><br><span class="line"><span class="string">         &lt;/div&gt;</span></span><br><span class="line"><span class="string">         &lt;div class="cmt-item-data-wrap" id="&#123;&#123;objectId&#125;&#125;" data-placeholder="&#123;&#123;userName&#125;&#125;"&gt;</span></span><br><span class="line"><span class="string">           &lt;div class="cmt-item-data-hd"&gt;</span></span><br><span class="line"><span class="string">             &lt;span class="cmt-item-data-floor"&gt;#&#123;&#123;floor&#125;&#125;&lt;/span&gt;</span></span><br><span class="line"><span class="string">             &lt;span class="cmt-item-data-user"&gt;&#123;&#123;userName&#125;&#125;&lt;/span&gt;</span></span><br><span class="line"><span class="string">             &lt;span class="cmt-item-data-time"&gt;&#123;&#123;createTime&#125;&#125;&lt;/span&gt;</span></span><br><span class="line"><span class="string">           &lt;/div&gt;</span></span><br><span class="line"><span class="string">           &lt;p class="cmt-item-data"&gt;&#123;&#123;cmtData&#125;&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">           &lt;div class="cmt-item-data-hd-ft"&gt;</span></span><br><span class="line"><span class="string">             &lt;a class="cmt-item-reply-btn" data-event="reply" data-id="&#123;&#123;objectId&#125;&#125;"&gt;å›å¤&lt;/a&gt;</span></span><br><span class="line"><span class="string">           &lt;/div&gt;</span></span><br><span class="line"><span class="string">           &lt;ul class="reply-list" id="&#123;&#123;UlId&#125;&#125;"&gt;</span></span><br><span class="line"><span class="string">             &lt;!--placeholder--&gt;</span></span><br><span class="line"><span class="string">           &lt;/ul&gt;</span></span><br><span class="line"><span class="string">         &lt;/div&gt;</span></span><br><span class="line"><span class="string">     `</span>&#125;,</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ä¸»è¦é€»è¾‘</span></span><br><span class="line">   <span class="keyword">let</span> CMT = &#123;</span><br><span class="line">     init(configObj)&#123;</span><br><span class="line">       <span class="keyword">if</span> (!configObj.el) &#123;</span><br><span class="line">         <span class="built_in">console</span>.log(<span class="string">'ç¼ºå°‘ç›®æ ‡å®¹å™¨'</span>);</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (!configObj.appId) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'è¯·å¡«å†™appId'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (!configObj.appKey) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'è¯·å¡«å†™appKey'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span>(<span class="keyword">typeof</span> MD5==<span class="string">'undefined'</span>)&#123;</span><br><span class="line">        <span class="keyword">this</span>.MD5=<span class="function"><span class="keyword">function</span>(<span class="params">str</span>)</span>&#123;<span class="keyword">return</span> str&#125;;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.MD5=MD5;</span><br><span class="line">       &#125;</span><br><span class="line">       AV.init(configObj.appId, configObj.appKey);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.el = <span class="built_in">document</span>.querySelector(configObj.el);</span><br><span class="line">       <span class="comment">// æ¸²æŸ“æ¨¡æ¿</span></span><br><span class="line">       <span class="keyword">this</span>.buildTpl();</span><br><span class="line">       <span class="comment">// å‡ºæ‰€æœ‰è¯„è®º</span></span><br><span class="line">       <span class="keyword">this</span>.renderAllCmt();</span><br><span class="line">       <span class="comment">// ç»‘å®šå„ç§äº‹ä»¶</span></span><br><span class="line">       <span class="keyword">this</span>.bindEvent();</span><br><span class="line">       <span class="comment">// è¯»å–localstorage</span></span><br><span class="line">       <span class="keyword">this</span>.fetchUserInfo();</span><br><span class="line">     &#125;,</span><br><span class="line">     buildTpl()&#123;</span><br><span class="line">       <span class="keyword">this</span>.generateMainView();  <span class="comment">//ä¸»ç•Œé¢ç»“æ„</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.generateForm(&#123; <span class="comment">// ç”Ÿæˆä¸»è¯„è®ºæ¡†</span></span><br><span class="line">         cmtId : <span class="string">'JmainCmt'</span>,</span><br><span class="line">         eventType: <span class="string">'postCmt'</span>,</span><br><span class="line">         btnTxt: <span class="string">'æäº¤è¯„è®º'</span>,</span><br><span class="line">         callBack:<span class="function">(<span class="params">newCmtEle</span>)=&gt;</span>&#123;</span><br><span class="line">           doc.querySelector(<span class="string">'.cmt-postcomment'</span>).appendChild(newCmtEle);</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">     &#125;,</span><br><span class="line">     generateReplyForm(cb)&#123;</span><br><span class="line">       <span class="keyword">this</span>.generateForm(&#123;  <span class="comment">// ç”Ÿæˆå›å¤æ¡†, åˆå§‹çŠ¶æ€éšè—</span></span><br><span class="line">         cmtId : <span class="string">'JreplyCmt'</span>,</span><br><span class="line">         eventType: <span class="string">'postReply'</span>,</span><br><span class="line">         btnTxt: <span class="string">'æäº¤å›å¤'</span>,</span><br><span class="line">         hideLoginArea:<span class="literal">true</span>,</span><br><span class="line">         callBack:<span class="function">(<span class="params">newCmtEle</span>)=&gt;</span>&#123;</span><br><span class="line">           <span class="keyword">this</span>.replyForm =  newCmtEle.cloneNode(<span class="literal">true</span>);</span><br><span class="line">           cb &amp;&amp; cb();</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">     &#125;,</span><br><span class="line">     generateMainView()&#123;</span><br><span class="line">       <span class="keyword">this</span>.el.innerHTML = TPL.mainView()</span><br><span class="line">     &#125;,</span><br><span class="line">     generateForm(configObj)&#123;</span><br><span class="line">       <span class="keyword">let</span> div = doc.createElement(<span class="string">'div'</span>)</span><br><span class="line">       div.classList +=<span class="string">'cmt-area-con'</span>;</span><br><span class="line">       div.innerHTML = TPL.cmtFormTpl(configObj.hideLoginArea)</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;eventType&#125;&#125;/g</span>,configObj.eventType)</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;btnTxt&#125;&#125;/g</span>,configObj.btnTxt)</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;cmtId&#125;&#125;/g</span>,configObj.cmtId);</span><br><span class="line">       configObj.callBack &amp;&amp; configObj.callBack(div);</span><br><span class="line">     &#125;,</span><br><span class="line">     getData(el,name)&#123;</span><br><span class="line">       <span class="keyword">return</span> el.getAttribute(<span class="string">'data-'</span>+name)</span><br><span class="line">     &#125;,</span><br><span class="line">     setData(el,name,val)&#123;</span><br><span class="line">       el.setAttribute(<span class="string">'data-'</span>+name,val)</span><br><span class="line">     &#125;,</span><br><span class="line">     setPlaceHolder(cmtEle)&#123;</span><br><span class="line">      <span class="keyword">if</span> (CONFIG.replyType==<span class="string">'div'</span>) &#123;</span><br><span class="line">        <span class="comment">// div+cssä¸‹ä¸èƒ½åŠ¨æ€æ›´æ–°placeholder</span></span><br><span class="line">        cmtEle.setAttribute(<span class="string">'placeholder'</span>, <span class="string">'å›å¤@'</span>+<span class="keyword">this</span>.placeholder+<span class="string">':'</span>)</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">       cmtEle.placeholder = <span class="string">'å›å¤@'</span>+<span class="keyword">this</span>.placeholder+<span class="string">':'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     checkInput(cmtEle)&#123;</span><br><span class="line">       <span class="keyword">return</span> CONFIG.cmtType==<span class="string">'div'</span>? cmtEle.innerHTML.trim().length : cmtEle.value.trim().length;</span><br><span class="line">     &#125;,</span><br><span class="line">     setFocus(cmtEle)&#123;</span><br><span class="line">       cmtEle.focus();</span><br><span class="line">       <span class="keyword">if</span> (CONFIG.cmtType==<span class="string">'div'</span>) &#123;</span><br><span class="line">         <span class="keyword">let</span> range = win.getSelection();</span><br><span class="line">         range.selectAllChildren(cmtEle);</span><br><span class="line">         range.collapseToEnd();</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     safeTxt(con)&#123;</span><br><span class="line">      <span class="keyword">return</span> con.replace(<span class="regexp">/&lt;/ig</span>, <span class="string">'&amp;lt;'</span>).replace(<span class="regexp">/&gt;/ig</span>, <span class="string">'&amp;gt;'</span>)</span><br><span class="line">     &#125;,</span><br><span class="line">     getContent(cmtEle) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">this</span>.getCleanText(cmtEle)</span><br><span class="line">         .replace(<span class="regexp">/&lt;/ig</span>, <span class="string">'&amp;lt;'</span>)</span><br><span class="line">         .replace(<span class="regexp">/&gt;/ig</span>, <span class="string">'&amp;gt;'</span>);</span><br><span class="line">     &#125;,</span><br><span class="line">     randomID(prefix) &#123;</span><br><span class="line">       <span class="keyword">return</span> prefix + <span class="built_in">Math</span>.random().toString(<span class="number">32</span>).slice(<span class="number">2</span>);</span><br><span class="line">     &#125;,</span><br><span class="line">     stripTags: <span class="function"><span class="keyword">function</span>(<span class="params">el, tagName</span>) </span>&#123;</span><br><span class="line">       <span class="keyword">let</span> els = el.getElementsByTagName(tagName.toUpperCase());</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; els.length; i++) &#123;</span><br><span class="line">         <span class="keyword">while</span> (els[i].firstChild)</span><br><span class="line">           els[i].parentNode.insertBefore(els[i].removeChild(els[i].firstChild), els[i]);</span><br><span class="line">         els[i].parentNode.removeChild(els[i--]);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     getCleanText(cmtEle) &#123;</span><br><span class="line">       <span class="keyword">let</span> ele = cmtEle;</span><br><span class="line">       <span class="keyword">let</span> clone = ele.cloneNode(<span class="literal">true</span>);</span><br><span class="line">       <span class="keyword">let</span> _v = <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">if</span>(CONFIG.cmtType==<span class="string">'div'</span>)&#123;</span><br><span class="line">         clone.innerHTML = <span class="keyword">this</span>.html2txt(clone.innerHTML);</span><br><span class="line">         <span class="keyword">this</span>.stripTags(clone, <span class="string">'*'</span>);</span><br><span class="line">         _v = clone.innerHTML.replace(<span class="regexp">/(?:\s|&amp;nbsp;)*$/g</span>, <span class="string">''</span>);</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         clone.value = <span class="keyword">this</span>.html2txt(clone.value);</span><br><span class="line">         <span class="keyword">this</span>.stripTags(clone, <span class="string">'*'</span>);</span><br><span class="line">         _v = clone.value.replace(<span class="regexp">/(?:\s|&amp;nbsp;)*$/g</span>, <span class="string">''</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> _v;</span><br><span class="line">     &#125;,</span><br><span class="line">     html2txt(html) &#123;</span><br><span class="line">       <span class="keyword">let</span> res = html.replace(<span class="regexp">/&amp;nbsp;/igm</span>, <span class="string">' '</span>)</span><br><span class="line">         .replace(<span class="regexp">/(?:&lt;br\s*\\?&gt;)+/igm</span>, <span class="string">'\n'</span>)</span><br><span class="line">         .replace(<span class="regexp">/&lt;div&gt;(.*?)&lt;\/div&gt;/igm</span>, <span class="string">"\n$1"</span>)</span><br><span class="line">         .replace(<span class="regexp">/&lt;p&gt;(.*?)&lt;\/p&gt;/igm</span>, <span class="string">"\n$1"</span>);</span><br><span class="line">       <span class="keyword">return</span> res;</span><br><span class="line">     &#125;,</span><br><span class="line">     clearCmt(cmtEle)&#123;</span><br><span class="line">       <span class="keyword">if</span> (CONFIG.cmtType==<span class="string">'div'</span>) &#123;</span><br><span class="line">         cmtEle.innerHTML = <span class="string">''</span></span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         cmtEle.value = <span class="string">''</span></span><br><span class="line">       &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     renderCmt(configObj)&#123;</span><br><span class="line">       <span class="keyword">let</span> ret = configObj.ret,</span><br><span class="line">         newInsert = configObj.newInsert;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">let</span> targetFloor = ret.get(<span class="string">'targetFloor'</span>),</span><br><span class="line">         hasTargetFloor =!!targetFloor,</span><br><span class="line">         _objectId = ret.get(<span class="string">'objectId'</span>),  <span class="comment">//ç•™è¨€id</span></span><br><span class="line">         con = <span class="built_in">decodeURIComponent</span>(ret.get(<span class="string">'comment'</span>)),</span><br><span class="line">         _floor = ret.cid.split(<span class="string">'c'</span>)[<span class="number">1</span>],</span><br><span class="line">         <span class="comment">// æ˜µç§°,ä¸ªäººç½‘å€è¦è®°å¾—é˜²XSS</span></span><br><span class="line">         _email = ret.get(<span class="string">'email'</span>),</span><br><span class="line">         _nick = <span class="keyword">this</span>.safeTxt(ret.get(<span class="string">'nick'</span>)),</span><br><span class="line">         _link = ret.get(<span class="string">'link'</span>),</span><br><span class="line">         _time = Tool.formatTime(ret.get(<span class="string">'createdAt'</span>));</span><br><span class="line"></span><br><span class="line">       <span class="keyword">let</span> _con = <span class="string">''</span>, tpl = <span class="string">''</span>,avatarUrl=<span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!!_email) &#123;</span><br><span class="line">        avatarUrl =CONFIG.avatarUrl+<span class="keyword">this</span>.MD5(_email)+<span class="string">'?s=50&amp;d=identicon'</span>;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        avatarUrl = CONFIG.avatarUrl</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (hasTargetFloor) &#123;</span><br><span class="line">         _con = <span class="string">'&lt;i&gt;@'</span>+<span class="keyword">this</span>.cache[targetFloor].get(<span class="string">'nick'</span>)</span><br><span class="line">            +<span class="string">' #'</span>+<span class="keyword">this</span>.cache[targetFloor].cid.split(<span class="string">'c'</span>)[<span class="number">1</span>]</span><br><span class="line">            +<span class="string">' &lt;/i&gt;'</span>+con;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         _con = con;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       tpl = TPL.cmtItemTpl()</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;objectId&#125;&#125;/g</span>,_objectId)</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;floor&#125;&#125;/g</span>,_floor)</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;userName&#125;&#125;/g</span>,_nick)</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;userCenter&#125;&#125;/g</span>,(!!_link?<span class="keyword">this</span>.safeTxt(_link):<span class="string">'javascript:;'</span>))</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;createTime&#125;&#125;/g</span>,(newInsert?<span class="string">'åˆšåˆš'</span>:_time))</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;cmtData&#125;&#125;/g</span>,_con)</span><br><span class="line">         .replace(<span class="regexp">/&#123;&#123;avatarUrl&#125;&#125;/g</span>,avatarUrl)</span><br><span class="line"></span><br><span class="line">       <span class="keyword">let</span> ele = doc.createElement(<span class="string">'li'</span>);</span><br><span class="line">       ele.classList =<span class="string">'cmt-item'</span>;</span><br><span class="line">       ele.innerHTML = tpl;</span><br><span class="line">       <span class="keyword">return</span> ele;</span><br><span class="line">     &#125;,</span><br><span class="line">     getAllComments(cb)&#123;</span><br><span class="line">       <span class="keyword">let</span> query = <span class="keyword">new</span> AV.Query(CONFIG.dataBase);</span><br><span class="line">       <span class="comment">// æ ¹æ®é¡µé¢URL(æˆ–è€…é¡µé¢æ ‡é¢˜)æ¥æŸ¥æ‰¾å¯¹åº”çš„è¯„è®º</span></span><br><span class="line">       query.equalTo(<span class="string">'url'</span>, cmtDataObj[<span class="string">'url'</span>]);</span><br><span class="line">       <span class="keyword">if</span> (CONFIG.sort) &#123;</span><br><span class="line">         query.descending(<span class="string">'createdAt'</span>);  <span class="comment">//ä»æ–°åˆ°æ—§</span></span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         query.ascending(<span class="string">'createdAt'</span>);  <span class="comment">//ä»æ—§åˆ°æ–°</span></span><br><span class="line">       &#125;</span><br><span class="line">       query.find().then(<span class="function">(<span class="params">ret</span>)=&gt;</span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.setCache(ret);</span><br><span class="line">         <span class="keyword">this</span>.setCmtNum();</span><br><span class="line">         cb &amp;&amp; cb(ret)</span><br><span class="line">       &#125;)</span><br><span class="line">     &#125;,</span><br><span class="line">     setCache(ret)&#123;</span><br><span class="line">       <span class="keyword">this</span>.cache = &#123;&#125;;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; ret.length; i++) &#123;</span><br><span class="line">         <span class="keyword">this</span>.cache[ret[i].id] = ret[i];</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     updateCache(obj)&#123;</span><br><span class="line">       <span class="keyword">this</span>.cache[obj.id] = obj;</span><br><span class="line">       <span class="keyword">this</span>._len = <span class="built_in">Object</span>.getOwnPropertyNames(<span class="keyword">this</span>.cache).length;</span><br><span class="line">     &#125;,</span><br><span class="line">     renderAllCmt()&#123;</span><br><span class="line">       <span class="keyword">this</span>.getAllComments(<span class="function">(<span class="params">ret</span>)=&gt;</span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (CONFIG.replyType==<span class="string">'normal'</span>) &#123;</span><br><span class="line">           <span class="keyword">let</span> fragment = doc.createDocumentFragment();</span><br><span class="line"></span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; ret.length; i++) &#123;</span><br><span class="line">             fragment.appendChild(<span class="keyword">this</span>.renderCmt(&#123;</span><br><span class="line">               ret:ret[i],</span><br><span class="line">               newInsert:<span class="literal">false</span></span><br><span class="line">             &#125;));</span><br><span class="line">           &#125;</span><br><span class="line">           JcmtList.appendChild(fragment);</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;)</span><br><span class="line">     &#125;,</span><br><span class="line">     renderNewCmt(ret)&#123;</span><br><span class="line">       <span class="keyword">let</span> li = <span class="keyword">this</span>.renderCmt(&#123;</span><br><span class="line">         ret:ret,</span><br><span class="line">         newInsert:<span class="literal">true</span></span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// åˆ¤æ–­æ’å…¥ä½ç½®</span></span><br><span class="line">       <span class="function"><span class="keyword">function</span> <span class="title">normalSort</span>(<span class="params">parent</span>)</span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (CONFIG.sort) &#123;</span><br><span class="line">           parent.prepend(li);</span><br><span class="line">         &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           parent.appendChild(li);</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       normalSort(JcmtList);</span><br><span class="line">     &#125;,</span><br><span class="line">     setCmtNum()&#123;</span><br><span class="line">       <span class="keyword">let</span> ele = doc.querySelector(<span class="string">'.cmt-count'</span>)</span><br><span class="line">       <span class="keyword">this</span>._len = <span class="built_in">Object</span>.getOwnPropertyNames(<span class="keyword">this</span>.cache).length;</span><br><span class="line">       ele.innerHTML = <span class="keyword">this</span>._len;</span><br><span class="line">     &#125;,</span><br><span class="line">     saveComment(sucess,fail)&#123;</span><br><span class="line">       <span class="keyword">let</span> av = AV.Object.extend(CONFIG.dataBase);</span><br><span class="line">       <span class="keyword">let</span> instance = <span class="keyword">new</span> av();</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> cmtDataObj) &#123;</span><br><span class="line">         <span class="keyword">if</span> (cmtDataObj.hasOwnProperty(i)) &#123;</span><br><span class="line">           <span class="keyword">let</span> _v = cmtDataObj[i];</span><br><span class="line">           instance.set(i, _v);</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       instance.save().then(<span class="function">(<span class="params">ret</span>)=&gt;</span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.updateCache(ret);</span><br><span class="line">         sucess &amp;&amp; sucess(ret);</span><br><span class="line">       &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">         fail &amp;&amp; fail(error);</span><br><span class="line">       &#125;);</span><br><span class="line">     &#125;,</span><br><span class="line">     postData(configObj)&#123;</span><br><span class="line">       <span class="keyword">let</span> cmtEle = configObj.cmtEle,</span><br><span class="line">         sucess = configObj.sucess,</span><br><span class="line">         fail = configObj.fail;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">let</span> len = <span class="keyword">this</span>.checkInput(cmtEle)</span><br><span class="line">       <span class="keyword">if</span> (len==<span class="number">0</span>) &#123;</span><br><span class="line">         alert(<span class="string">'è¯·è¾“å…¥è¯„è®º'</span>);</span><br><span class="line">         <span class="keyword">this</span>.setFocus(cmtEle) <span class="comment">//è¯„è®ºæ¡†</span></span><br><span class="line">         <span class="keyword">return</span> !<span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">let</span> html = <span class="keyword">this</span>.getContent(cmtEle);</span><br><span class="line"></span><br><span class="line">       cmtDataObj.comment = html; <span class="comment">//æŒ‚è½½åˆ°æ•°æ®åŒ…</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">// è¯»å–æœ€åçš„ç”¨æˆ·æ•°æ®</span></span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; CONFIG.lsArr.length; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> v = localStorage[CONFIG.lsPrefix+CONFIG.lsArr[i]];</span><br><span class="line">        <span class="keyword">if</span> (!!v) &#123;</span><br><span class="line">           cmtDataObj[CONFIG.lsArr[i]] = v;</span><br><span class="line">        &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       cmtEle==JmainCmt &amp;&amp; (cmtDataObj.targetFloor=<span class="string">''</span>); <span class="comment">// ä¸»è¯„è®ºæ²¡æœ‰ç›®æ ‡æ¥¼å±‚</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.saveComment(<span class="function">(<span class="params">ret</span>)=&gt;</span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.renderNewCmt(ret);</span><br><span class="line">         <span class="keyword">this</span>.clearCmt(cmtEle);</span><br><span class="line">         <span class="keyword">this</span>.setCmtNum();</span><br><span class="line">         sucess &amp;&amp; sucess()</span><br><span class="line">       &#125;,(error)=&gt;&#123;</span><br><span class="line">         <span class="built_in">console</span>.log(error)</span><br><span class="line">         fail &amp;&amp; fail()</span><br><span class="line">       &#125;);</span><br><span class="line">     &#125;,</span><br><span class="line">     insertReplyForm(wrap)&#123;</span><br><span class="line">       <span class="keyword">this</span>.lastId = wrap.id;</span><br><span class="line">       wrap.appendChild(<span class="keyword">this</span>.replyForm);</span><br><span class="line">       <span class="keyword">this</span>.setData(wrap,<span class="string">'status'</span>,<span class="string">'1'</span>);</span><br><span class="line">       <span class="keyword">this</span>.setPlaceHolder(JreplyCmt);</span><br><span class="line">       <span class="keyword">this</span>.replyForm.style.display = <span class="string">'block'</span>;</span><br><span class="line">       <span class="keyword">this</span>.setFocus(JreplyCmt);</span><br><span class="line">       cmtDataObj.targetFloor = <span class="keyword">this</span>.lastId;</span><br><span class="line">     &#125;,</span><br><span class="line">     removeReplyForm(cb)&#123;</span><br><span class="line">       <span class="keyword">let</span> lastTarget =  doc.getElementById(<span class="keyword">this</span>.lastId)</span><br><span class="line">       <span class="keyword">this</span>.setData(lastTarget,<span class="string">'status'</span>,<span class="string">'0'</span>)</span><br><span class="line">       <span class="keyword">this</span>.replyForm.style.display = <span class="string">'none'</span>;</span><br><span class="line">       doc.getElementById(<span class="keyword">this</span>.lastId).removeChild(<span class="keyword">this</span>.replyForm);</span><br><span class="line">       cb &amp;&amp; cb()</span><br><span class="line">     &#125;,</span><br><span class="line">     toggleReplyForm(wrap,isShowed)&#123;</span><br><span class="line">       <span class="keyword">if</span> (isShowed == <span class="string">'1'</span>) &#123;</span><br><span class="line">         <span class="keyword">this</span>.setData(wrap,<span class="string">'status'</span>,<span class="string">'0'</span>)</span><br><span class="line">         <span class="keyword">this</span>.replyForm.style.display = <span class="string">'none'</span>;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.setData(wrap,<span class="string">'status'</span>,<span class="string">'1'</span>)</span><br><span class="line">         <span class="keyword">this</span>.setPlaceHolder(JreplyCmt)</span><br><span class="line">         <span class="keyword">this</span>.replyForm.style.display = <span class="string">'block'</span>;</span><br><span class="line">         <span class="keyword">this</span>.setFocus(JreplyCmt);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     fetchUserInfo()&#123;</span><br><span class="line">      <span class="keyword">let</span> lsArr = CONFIG.lsArr;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; lsArr.length; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> ipt = doc.getElementById(<span class="string">'J'</span>+lsArr[i]);</span><br><span class="line">        ipt.value = localStorage.getItem(CONFIG.lsPrefix+lsArr[i]);</span><br><span class="line">      &#125;</span><br><span class="line">     &#125;,</span><br><span class="line">     bindEvent()&#123;</span><br><span class="line">       <span class="keyword">let</span> clickHandler = <span class="function">(<span class="params">e</span>)=&gt;</span>&#123;</span><br><span class="line">         <span class="keyword">let</span> target = e.target</span><br><span class="line">         <span class="keyword">let</span> eventType = <span class="keyword">this</span>.getData(target,<span class="string">'event'</span>);</span><br><span class="line">         <span class="keyword">switch</span>(eventType)&#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">'postCmt'</span> :</span><br><span class="line">             <span class="keyword">this</span>.postData(&#123;</span><br><span class="line">               cmtEle: JmainCmt,</span><br><span class="line">               sucess:<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;,</span><br><span class="line">               fail:<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;</span><br><span class="line">             &#125;);</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">'postReply'</span> :</span><br><span class="line">             <span class="keyword">this</span>.postData(&#123;</span><br><span class="line">               cmtEle:JreplyCmt,</span><br><span class="line">               sucess:<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">                 <span class="keyword">this</span>.toggleReplyForm(doc.getElementById(<span class="keyword">this</span>.lastId),<span class="string">'1'</span>);</span><br><span class="line">               &#125;,</span><br><span class="line">               fail:<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;</span><br><span class="line">             &#125;);</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">'reply'</span> :</span><br><span class="line">             <span class="keyword">let</span> targetId = <span class="keyword">this</span>.getData(target,<span class="string">'id'</span>); <span class="comment">// æŒ‰é’®å­˜å‚¨objectId</span></span><br><span class="line">             <span class="keyword">let</span> wrap = doc.getElementById(targetId),</span><br><span class="line">               isShowed = <span class="keyword">this</span>.getData(wrap,<span class="string">'status'</span>);</span><br><span class="line">             <span class="keyword">this</span>.placeholder = <span class="keyword">this</span>.getData(wrap,<span class="string">'placeholder'</span>);</span><br><span class="line"></span><br><span class="line">             <span class="keyword">if</span> (<span class="keyword">this</span>.lastId==<span class="literal">null</span>) &#123;</span><br><span class="line">               <span class="keyword">this</span>.generateReplyForm(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">                 <span class="keyword">this</span>.insertReplyForm(wrap);</span><br><span class="line">               &#125;);</span><br><span class="line">             &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               <span class="keyword">if</span> (<span class="keyword">this</span>.lastId==wrap.id) &#123;</span><br><span class="line">                 <span class="keyword">this</span>.toggleReplyForm(wrap,isShowed)</span><br><span class="line">               &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                 <span class="keyword">this</span>.removeReplyForm(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">                   <span class="keyword">this</span>.insertReplyForm(wrap);</span><br><span class="line">                   <span class="keyword">this</span>.toggleReplyForm(wrap,isShowed)</span><br><span class="line">                 &#125;);</span><br><span class="line">               &#125;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">default</span>:</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> keyUpHandler = <span class="function">(<span class="params">e</span>)=&gt;</span>&#123;</span><br><span class="line">        e.preventDefault();</span><br><span class="line">        <span class="keyword">let</span> target = e.target;</span><br><span class="line">        <span class="keyword">let</span> itemName = <span class="keyword">this</span>.getData(target,<span class="string">'name'</span>);</span><br><span class="line">        <span class="keyword">let</span> v =  target.value.trim();</span><br><span class="line">        <span class="keyword">switch</span> (itemName) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'nick'</span>:</span><br><span class="line">            localStorage.setItem(CONFIG.lsPrefix+<span class="string">'nick'</span>, v);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'email'</span>:</span><br><span class="line">            localStorage.setItem(CONFIG.lsPrefix+<span class="string">'email'</span>, v);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'link'</span>:</span><br><span class="line">            localStorage.setItem(CONFIG.lsPrefix+<span class="string">'link'</span>, v);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       doc.body.addEventListener(<span class="string">'click'</span>,clickHandler,<span class="literal">false</span>);</span><br><span class="line">       Jnick.addEventListener(<span class="string">'keyup'</span>,keyUpHandler,<span class="literal">false</span>);</span><br><span class="line">       Jemail.addEventListener(<span class="string">'keyup'</span>,keyUpHandler,<span class="literal">false</span>);</span><br><span class="line">       Jlink.addEventListener(<span class="string">'keyup'</span>,keyUpHandler,<span class="literal">false</span>);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   win.CMT = CMT;</span><br><span class="line">&#125;)(<span class="built_in">window</span>,<span class="built_in">document</span>);</span><br></pre></td></tr></table></figure></p>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>æŠŠæ‰‹å¤´çš„æ´»å¹²å®Œ, å†ç»§ç»­å®Œå–„Todoå§</p>

  </div>

</article>


  <nav id="pagenavi">
    
    <a href="/2018/11/13/curl/" class="prev">ä¸Šä¸€ç¯‡ï¼šå¸¸ç”¨CURLå‘½ä»¤</a>
    
    
    <a href="/2017/05/31/å®‰å“å¾®ä¿¡è§†é¢‘æ’­æ”¾å…¨å±é—®é¢˜å¤„ç†/" class="next">ä¸‹ä¸€ç¯‡ï¼šã€å¥‡æŠ€æ·«å·§ã€‘å®‰å“å¾®ä¿¡è§†é¢‘æ’­æ”¾å…¨å±é—®é¢˜å¤„ç†</a>
    
  </nav>

        </div>
        
        
          <div class="post-comments" id="Jcmt">
            <h1 class="post-comments-title">è®¿å®¢è¯„è®º</h1>
            <div id="Jcomment"></div>
          </div>
        
      </div>
      <footer id="footer" class="inner">
        Â© 2021 - æµ‹è¯•ç‹— -
        <span id="busuanzi_container_site_pv">PV <span id="busuanzi_value_site_pv"></span></span>
        <p>Powered by <a href="https://hexo.io/">Hexo</a> & <a href="https://github.com/thinkerchan/hexo-theme-greyshade">GreyShade</a></p>
      </footer>
    </div>
  </div>
  
  <script>
    let mod ={
      timePrefix:'t-',
      expire:1000*60*60,
      load:function(libName,libUrl,cb){
        let aval = (new Date).getTime() - localStorage.getItem(this.timePrefix+libName) < this.expire;
        let libStr = localStorage.getItem(libName)
        if (aval && libStr) {
          this.parseAndInsert(libStr)
          cb && cb(libStr);
        }else{
          this.ajax(libUrl,(str)=>{
            localStorage.setItem(libName, str)
            localStorage.setItem(this.timePrefix+libName, (new Date).getTime())
            this.parseAndInsert(str)
            cb && cb(str);
          })
        }
      },
      parseAndInsert(rawStr) {
        let script = document.createElement('script')
        script.innerHTML = rawStr
        document.body.appendChild(script)
      },
      ajax:function(url,cb){
        let xhr = new XMLHttpRequest;
        xhr.open('get', url, true)
        xhr.send();
        xhr.onreadystatechange = function () {
          if (xhr.readyState == 4 && xhr.status == 200) {
            cb && cb(xhr.responseText)
          }else{
            // console.log(xhr.readyState,xhr.status);
          }
        }
      },
      genCmt(){
        window.Valine && new Valine({
          el: '#Jcomment',
          appId: 'XPJzs0FfufkFfuBjbJraqhbo-gzGzoHsz',
          appKey: 'QoS0zL4Y2xTDviitGOPkvCGv',
          notify: true,
          verify: false,
          avatar: 'mm',
          pageSize: '10',
          placeholder: 'Valine+Leancloudæä¾›è¯„è®º'
        })
      }
    }

    mod.load('lib-av', 'https://cdn.jsdelivr.net/npm/leancloud-storage@3.0.1/dist/av-min.js', () => {
      mod.load('lib-cmt', 'https://unpkg.com/valine@1.4.14/dist/Valine.min.js',()=>{
        let t = setTimeout(() => {
          mod.genCmt()
          clearTimeout(t)
          t = null;
        }, 100);
      })
    })
  </script>
  
  <script async defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  
  <script async defer src="https://s5.cnzz.com/z_stat.php?id=1276809529&web_id=1276809529"></script>
  
</body>
</html>